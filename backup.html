<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-cn">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>[作业向]tinyhttp web服务器设计及完整代码 - 老司机 - 博客园</title>
<link type="text/css" rel="stylesheet" href="/bundles/blog-common.css?v=TdLMZRHMQfitXmNZ7SFinI4hbzrT2-_1PvIqhhWnsbI1"/>
<link id="MainCss" type="text/css" rel="stylesheet" href="/skins/Banlieue13/bundle-Banlieue13.css?v=-BwbBCgL4I6ev4eT0WChGlx86DuTjkHbdqzbBDeklxs1"/>
<link title="RSS" type="application/rss+xml" rel="alternate" href="http://www.cnblogs.com/zxh1210603696/rss"/>
<link title="RSD" type="application/rsd+xml" rel="EditURI" href="http://www.cnblogs.com/zxh1210603696/rsd.xml"/>
<link type="application/wlwmanifest+xml" rel="wlwmanifest" href="http://www.cnblogs.com/zxh1210603696/wlwmanifest.xml"/>
<script src="http://common.cnblogs.com/script/jquery.js" type="text/javascript"></script>  
<script type="text/javascript">var currentBlogApp = 'zxh1210603696', cb_enable_mathjax=false;</script>
<script src="/bundles/blog-common.js?v=PlJ9KQtkGa_ccgZxU9Fon-EDNUyrm0y3GKrHRkjy4p81" type="text/javascript"></script>
</head>
<body>
<a name="top"></a>

<!--done-->
<div id="home">
<div id="header">
	<div id="blogTitle">
	<a id="lnkBlogLogo" href="http://www.cnblogs.com/zxh1210603696/"><img id="blogLogo" src="/Skins/custom/images/logo.gif" alt="返回主页" /></a>			
		
<!--done-->
<h1><a id="Header1_HeaderTitle" class="headermaintitle" href="http://www.cnblogs.com/zxh1210603696/">老司机</a></h1>
<h2></h2>



		
	</div><!--end: blogTitle 博客的标题和副标题 -->
</div><!--end: header 头部 -->

<div id="main">
	<div id="mainContent">
	<div class="forFlow">
		<div id="navigator">
			
<!--done-->
			<ul id="navList">
				<li><a id="MyLinks1_HomeLink" class="menu" href="http://www.cnblogs.com/">博客园</a></li>
				<li><a id="MyLinks1_IngLink" class="menu" href="http://home.cnblogs.com/ing/">闪存</a></li>
				<li><a id="MyLinks1_MyHomeLink" class="menu" href="http://www.cnblogs.com/zxh1210603696/">首页</a></li>
				<li><a id="MyLinks1_NewPostLink" class="menu" rel="nofollow" href="http://i.cnblogs.com/EditPosts.aspx?opt=1">新随笔</a></li>
				<li><a id="MyLinks1_ContactLink" accesskey="9" class="menu" rel="nofollow" href="http://msg.cnblogs.com/send/%E8%80%81%E5%8F%B8%E6%9C%BA">联系</a></li>
				<li><a id="MyLinks1_Admin" class="menu" rel="nofollow" href="http://i.cnblogs.com/">管理</a></li>
				<li><a id="MyLinks1_Syndication" class="menu" href="http://www.cnblogs.com/zxh1210603696/rss">订阅</a>
				<a id="MyLinks1_XMLLink" class="aHeaderXML" href="http://www.cnblogs.com/zxh1210603696/rss"><img src="http://www.cnblogs.com/images/xml.gif" alt="订阅" /></a></li>
			</ul>


			<div class="blogStats">
				
				
<!--done-->
随笔- 53&nbsp;
文章- 0&nbsp;
评论- 77&nbsp;

				
			</div><!--end: blogStats -->
		</div><!--end: navigator 博客导航栏 -->
		
<div id="post_detail">
<!--done-->
<div id="topics">
	<div class = "post">
		<h1 class = "postTitle">
			<a id="cb_post_title_url" class="postTitle2" href="http://www.cnblogs.com/zxh1210603696/p/3371715.html">[作业向]tinyhttp web服务器设计及完整代码</a>
		</h1>
		<div class="clear"></div>
		<div class="postBody">
			<div id="cnblogs_post_body"><p>　　最近看了《HTTP权威指南》和《UNP》有了写一个简单的web服务器的想法，正好这个学期没有什么课，所以就花了一个星期这样写了一个出来，鉴于本人水平有限，如果有什么设计或代码错误的，希望各位指出哈。</p>
<p>tinyhttp web服务器的架构为epoll + 多线程 + sendfile， &nbsp;本来想用线程池代替的因为每来一个连接就new一个线程这样对于OS来说负担太大，并且线程一旦过多线程切换就会花费很大代价造成性能瓶颈，但是我打算之后单独写一个线程池代码示例的说，所以这个版本就使用多线程来代替线程池了。</p>
<p>tinyhttp暂时只支持GET和HEAD方法，支持的首部不多大概七八个吧，支持伪长连接（我觉得是伪的哈哈）。</p>
<p>话不多说，先上几张效果图吧：</p>
<p>这张是测试http请求和响应包的</p>
<p><img src="http://images.cnitblog.com/blog/548261/201310/16104300-ab306fe7ef924f128e1c8c0c6a1d1a51.png" alt="" width="755" height="423" />&nbsp;</p>
<p>这张是自己构造了一个包来收发的</p>
<p><img src="http://images.cnitblog.com/blog/548261/201310/16104436-31bce6a5f17749768f26011150bc3130.png" alt="" width="748" height="420" /></p>
<p>这张是我把google首页的源代码拿来测试的</p>
<p><img src="http://images.cnitblog.com/blog/548261/201310/16104525-93cba436c2044b079a228a1609c47556.png" alt="" width="767" height="431" /></p>
<p>这张是我自己写了一个html代码使用火狐浏览器来与的我tinyhttp web服务其通信的测试</p>
<p><img src="http://images.cnitblog.com/blog/548261/201310/16104635-ec72c30db73445d0b04ddf26bca6b00b.png" alt="" width="914" height="514" /></p>
<p>我的tinyhttp是可配置的，现阶段只支持domain和docroot配置项，domain就是你部署的网站域名，docroot想必学过网页的都知道是什么意思吧~</p>
<p><img src="http://images.cnitblog.com/blog/548261/201310/16105000-cef9979161ec4cda8175bc1ead321580.png" alt="" /></p>
<p>&nbsp;</p>
<p>好了，现在就把完整的源代码给出，总共有1500+行：</p>
<div class="cnblogs_code">
<pre><span style="color: #008080;">  1</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">  2</span> <span style="color: #008000;">*Author        Zou Xiao hang
</span><span style="color: #008080;">  3</span> <span style="color: #008000;">*Email        1210603696@qq.com
</span><span style="color: #008080;">  4</span> <span style="color: #008000;">*File Name    tinyhttp.h
</span><span style="color: #008080;">  5</span> <span style="color: #008000;">*Date         2013/10/05
</span><span style="color: #008080;">  6</span> <span style="color: #008000;">*/</span>
<span style="color: #008080;">  7</span> <span style="color: #000000;">#ifndef _TINY_HTTP_H_
</span><span style="color: #008080;">  8</span> <span style="color: #0000ff;">#define</span>    _TINY_HTTP_H_
<span style="color: #008080;">  9</span> 
<span style="color: #008080;"> 10</span> #include &lt;sys/socket.h&gt;
<span style="color: #008080;"> 11</span> #include &lt;sys/types.h&gt;
<span style="color: #008080;"> 12</span> #include &lt;stdlib.h&gt;
<span style="color: #008080;"> 13</span> #include &lt;stdio.h&gt;
<span style="color: #008080;"> 14</span> #include &lt;netdb.h&gt;
<span style="color: #008080;"> 15</span> #include &lt;sys/epoll.h&gt;
<span style="color: #008080;"> 16</span> #include &lt;strings.h&gt;
<span style="color: #008080;"> 17</span> #include &lt;<span style="color: #0000ff;">string</span>&gt;
<span style="color: #008080;"> 18</span> #include &lt;errno.h&gt;
<span style="color: #008080;"> 19</span> #include &lt;unistd.h&gt;
<span style="color: #008080;"> 20</span> #include &lt;fcntl.h&gt;
<span style="color: #008080;"> 21</span> #include &lt;utility&gt;
<span style="color: #008080;"> 22</span> #include &lt;fstream&gt;
<span style="color: #008080;"> 23</span> #include &lt;sstream&gt;
<span style="color: #008080;"> 24</span> #include &lt;map&gt;
<span style="color: #008080;"> 25</span> #include &lt;iostream&gt;
<span style="color: #008080;"> 26</span> #include &lt;<span style="color: #0000ff;">string</span>.h&gt;
<span style="color: #008080;"> 27</span> #include &lt;pthread.h&gt;
<span style="color: #008080;"> 28</span> #include &lt;netinet/tcp.h&gt;
<span style="color: #008080;"> 29</span> #include &lt;time.h&gt;
<span style="color: #008080;"> 30</span> #include &lt;sys/stat.h&gt;
<span style="color: #008080;"> 31</span> #include &lt;sys/sendfile.h&gt;
<span style="color: #008080;"> 32</span> 
<span style="color: #008080;"> 33</span> #include <span style="color: #800000;">"</span><span style="color: #800000;">utility.h</span><span style="color: #800000;">"</span>
<span style="color: #008080;"> 34</span> #include <span style="color: #800000;">"</span><span style="color: #800000;">parse.h</span><span style="color: #800000;">"</span>
<span style="color: #008080;"> 35</span> 
<span style="color: #008080;"> 36</span> <span style="color: #0000ff;">using</span> <span style="color: #0000ff;">namespace</span><span style="color: #000000;"> std;
</span><span style="color: #008080;"> 37</span> 
<span style="color: #008080;"> 38</span> typedef <span style="color: #0000ff;">struct</span><span style="color: #000000;"> _epollfd_connfd
</span><span style="color: #008080;"> 39</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 40</span>     <span style="color: #0000ff;">int</span><span style="color: #000000;"> epollfd;
</span><span style="color: #008080;"> 41</span>     <span style="color: #0000ff;">int</span><span style="color: #000000;"> connfd;
</span><span style="color: #008080;"> 42</span> <span style="color: #000000;">}_epollfd_connfd;
</span><span style="color: #008080;"> 43</span> 
<span style="color: #008080;"> 44</span> <span style="color: #008000;">/*</span><span style="color: #008000;">**********************************  常数定义  
</span><span style="color: #008080;"> 45</span> <span style="color: #008000;">******************************************</span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 46</span> <span style="color: #0000ff;">#define</span> MAX_EVENTS    1024    <span style="color: #008000;">//</span><span style="color: #008000;">epoll最大监听事件数</span>
<span style="color: #008080;"> 47</span> <span style="color: #0000ff;">#define</span> MAX_BACKLOG    100        <span style="color: #008000;">//</span><span style="color: #008000;">监听队列最大数</span>
<span style="color: #008080;"> 48</span> <span style="color: #008000;">/*</span><span style="color: #008000;">*****************************************************************************
</span><span style="color: #008080;"> 49</span> <span style="color: #008000;">**********</span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 50</span> 
<span style="color: #008080;"> 51</span> <span style="color: #008000;">/*</span><span style="color: #008000;">**********************************  保存配置文件相关值  
</span><span style="color: #008080;"> 52</span> <span style="color: #008000;">********************************</span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 53</span> <span style="color: #0000ff;">string</span> tyhp_domain(<span style="color: #800000;">""</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 54</span> <span style="color: #0000ff;">string</span> tyhp_docroot(<span style="color: #800000;">""</span><span style="color: #000000;">); 
</span><span style="color: #008080;"> 55</span> <span style="color: #008000;">/*</span><span style="color: #008000;">*****************************************************************************
</span><span style="color: #008080;"> 56</span> <span style="color: #008000;">**********</span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 57</span> 
<span style="color: #008080;"> 58</span> <span style="color: #008000;">/*</span><span style="color: #008000;">**********************************  MIME定义  
</span><span style="color: #008080;"> 59</span> <span style="color: #008000;">******************************************</span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 60</span> typedef <span style="color: #0000ff;">struct</span><span style="color: #000000;"> mime_node
</span><span style="color: #008080;"> 61</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 62</span>     <span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *<span style="color: #000000;">type;
</span><span style="color: #008080;"> 63</span>     <span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *<span style="color: #000000;">value;
</span><span style="color: #008080;"> 64</span> <span style="color: #000000;">}mime_node;
</span><span style="color: #008080;"> 65</span> 
<span style="color: #008080;"> 66</span> mime_node tyhp_mime[] = 
<span style="color: #008080;"> 67</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 68</span>     {<span style="color: #800000;">"</span><span style="color: #800000;">.html</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">text/html</span><span style="color: #800000;">"</span><span style="color: #000000;">},
</span><span style="color: #008080;"> 69</span>     {<span style="color: #800000;">"</span><span style="color: #800000;">.xml</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">text/xml</span><span style="color: #800000;">"</span><span style="color: #000000;">},
</span><span style="color: #008080;"> 70</span>     {<span style="color: #800000;">"</span><span style="color: #800000;">.xhtml</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">application/xhtml+xml</span><span style="color: #800000;">"</span><span style="color: #000000;">},
</span><span style="color: #008080;"> 71</span>     {<span style="color: #800000;">"</span><span style="color: #800000;">.txt</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">text/plain</span><span style="color: #800000;">"</span><span style="color: #000000;">},
</span><span style="color: #008080;"> 72</span>     {<span style="color: #800000;">"</span><span style="color: #800000;">.rtf</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">application/rtf</span><span style="color: #800000;">"</span><span style="color: #000000;">},
</span><span style="color: #008080;"> 73</span>     {<span style="color: #800000;">"</span><span style="color: #800000;">.pdf</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">application/pdf</span><span style="color: #800000;">"</span><span style="color: #000000;">},
</span><span style="color: #008080;"> 74</span>     {<span style="color: #800000;">"</span><span style="color: #800000;">.word</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">application/msword</span><span style="color: #800000;">"</span><span style="color: #000000;">},
</span><span style="color: #008080;"> 75</span>     {<span style="color: #800000;">"</span><span style="color: #800000;">.png</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">image/png</span><span style="color: #800000;">"</span><span style="color: #000000;">},
</span><span style="color: #008080;"> 76</span>     {<span style="color: #800000;">"</span><span style="color: #800000;">.gif</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">image/gif</span><span style="color: #800000;">"</span><span style="color: #000000;">},
</span><span style="color: #008080;"> 77</span>     {<span style="color: #800000;">"</span><span style="color: #800000;">.jpg</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">image/jpeg</span><span style="color: #800000;">"</span><span style="color: #000000;">},
</span><span style="color: #008080;"> 78</span>     {<span style="color: #800000;">"</span><span style="color: #800000;">.jpeg</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">image/jpeg</span><span style="color: #800000;">"</span><span style="color: #000000;">},
</span><span style="color: #008080;"> 79</span>     {<span style="color: #800000;">"</span><span style="color: #800000;">.au</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">audio/basic</span><span style="color: #800000;">"</span><span style="color: #000000;">},
</span><span style="color: #008080;"> 80</span>     {<span style="color: #800000;">"</span><span style="color: #800000;">.mpeg</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">video/mpeg</span><span style="color: #800000;">"</span><span style="color: #000000;">},
</span><span style="color: #008080;"> 81</span>     {<span style="color: #800000;">"</span><span style="color: #800000;">.mpg</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">video/mpeg</span><span style="color: #800000;">"</span><span style="color: #000000;">},
</span><span style="color: #008080;"> 82</span>     {<span style="color: #800000;">"</span><span style="color: #800000;">.avi</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">video/x-msvideo</span><span style="color: #800000;">"</span><span style="color: #000000;">},
</span><span style="color: #008080;"> 83</span>     {<span style="color: #800000;">"</span><span style="color: #800000;">.gz</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">application/x-gzip</span><span style="color: #800000;">"</span><span style="color: #000000;">},
</span><span style="color: #008080;"> 84</span>     {<span style="color: #800000;">"</span><span style="color: #800000;">.tar</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">application/x-tar</span><span style="color: #800000;">"</span><span style="color: #000000;">},
</span><span style="color: #008080;"> 85</span> <span style="color: #000000;">    {NULL ,NULL}
</span><span style="color: #008080;"> 86</span> <span style="color: #000000;">};
</span><span style="color: #008080;"> 87</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;"> 88</span> <span style="color: #008000;"> *函数作用：将MIME的type转换为相应的value
</span><span style="color: #008080;"> 89</span> <span style="color: #008000;"> *函数参数：type
</span><span style="color: #008080;"> 90</span> <span style="color: #008000;"> *函数返回值: NULL表示type在MIME中不存在，否则返回相应value的指针
</span><span style="color: #008080;"> 91</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 92</span> inline <span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span>* tyhp_mime_type2value(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *<span style="color: #000000;">type)
</span><span style="color: #008080;"> 93</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 94</span>     <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i = <span style="color: #800080;">0</span>; tyhp_mime[i].type != NULL; ++<span style="color: #000000;">i)
</span><span style="color: #008080;"> 95</span> <span style="color: #000000;">    {
</span><span style="color: #008080;"> 96</span>         <span style="color: #0000ff;">if</span>(strcmp(type, tyhp_mime[i].type) == <span style="color: #800080;">0</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 97</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> tyhp_mime[i].value;
</span><span style="color: #008080;"> 98</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 99</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> NULL;
</span><span style="color: #008080;">100</span> <span style="color: #000000;">}
</span><span style="color: #008080;">101</span> <span style="color: #008000;">/*</span><span style="color: #008000;">*****************************************************************************
</span><span style="color: #008080;">102</span> <span style="color: #008000;">**********</span><span style="color: #008000;">*/</span>
<span style="color: #008080;">103</span> 
<span style="color: #008080;">104</span> <span style="color: #008000;">/*</span><span style="color: #008000;">**********************************  HTTP状态码  
</span><span style="color: #008080;">105</span> <span style="color: #008000;">******************************************</span><span style="color: #008000;">*/</span>
<span style="color: #008080;">106</span> <span style="color: #0000ff;">#define</span> TYHP_CONTINUE         100    <span style="color: #008000;">//</span><span style="color: #008000;">收到了请求的起始部分，客户端应该继续请求</span>
<span style="color: #008080;">107</span> 
<span style="color: #008080;">108</span> <span style="color: #0000ff;">#define</span> TYHP_OK                200    <span style="color: #008000;">//</span><span style="color: #008000;">服务器已经成功处理请求</span>
<span style="color: #008080;">109</span> <span style="color: #0000ff;">#define</span> TYHP_ACCEPTED        202    <span style="color: #008000;">//</span><span style="color: #008000;">请求已接受，服务器尚未处理</span>
<span style="color: #008080;">110</span> 
<span style="color: #008080;">111</span> <span style="color: #0000ff;">#define</span> TYHP_MOVED            301    <span style="color: #008000;">//</span><span style="color: #008000;">请求的URL已移走，响应应该包含Location URL</span>
<span style="color: #008080;">112</span> <span style="color: #0000ff;">#define</span>    TYHP_FOUND            302    <span style="color: #008000;">//</span><span style="color: #008000;">请求的URL临时移走，响应应该包含Location URL</span>
<span style="color: #008080;">113</span> <span style="color: #0000ff;">#define</span> TYHP_SEEOTHER        303    <span style="color: #008000;">//</span><span style="color: #008000;">告诉客户端应该用另一个URL获取资源，响应应该包含</span>
<span style="color: #008080;">114</span> <span style="color: #000000;">Location URL
</span><span style="color: #008080;">115</span> <span style="color: #0000ff;">#define</span> TYHP_NOTMODIFIED    304    <span style="color: #008000;">//</span><span style="color: #008000;">资源未发生变化</span>
<span style="color: #008080;">116</span> 
<span style="color: #008080;">117</span> <span style="color: #0000ff;">#define</span> TYHP_BADREQUEST        400    <span style="color: #008000;">//</span><span style="color: #008000;">客户端发送了一条异常请求</span>
<span style="color: #008080;">118</span> <span style="color: #0000ff;">#define</span> TYHP_FORBIDDEN        403    <span style="color: #008000;">//</span><span style="color: #008000;">服务器拒绝请求</span>
<span style="color: #008080;">119</span> <span style="color: #0000ff;">#define</span> TYHP_NOTFOUND        404    <span style="color: #008000;">//</span><span style="color: #008000;">URL未找到</span>
<span style="color: #008080;">120</span> 
<span style="color: #008080;">121</span> 
<span style="color: #008080;">122</span> <span style="color: #0000ff;">#define</span> TYHP_ERROR            500    <span style="color: #008000;">//</span><span style="color: #008000;">服务器出错</span>
<span style="color: #008080;">123</span> <span style="color: #0000ff;">#define</span> TYHP_NOIMPLEMENTED    501 <span style="color: #008000;">//</span><span style="color: #008000;">服务器不支持当前请求所需要的某个功能</span>
<span style="color: #008080;">124</span> <span style="color: #0000ff;">#define</span> TYHP_BADGATEWAY        502    
<span style="color: #008080;">125</span> <span style="color: #008000;">//</span><span style="color: #008000;">作为代理或网关使用的服务器遇到了来自响应链中上游的无效响应</span>
<span style="color: #008080;">126</span> <span style="color: #0000ff;">#define</span> TYHP_SRVUNAVAILABLE    503 
<span style="color: #008080;">127</span> <span style="color: #008000;">//</span><span style="color: #008000;">服务器目前无法提供请求服务，过一段时间后可以恢复</span>
<span style="color: #008080;">128</span> 
<span style="color: #008080;">129</span> <span style="color: #0000ff;">char</span> tyhp_ok[] =             <span style="color: #800000;">"</span><span style="color: #800000;">OK</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">130</span> <span style="color: #0000ff;">char</span> tyhp_badrequest[] =     <span style="color: #800000;">"</span><span style="color: #800000;">Bad Request</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">131</span> <span style="color: #0000ff;">char</span> tyhp_forbidden[] =        <span style="color: #800000;">"</span><span style="color: #800000;">Forbidden</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">132</span> <span style="color: #0000ff;">char</span> tyhp_notfound[] =         <span style="color: #800000;">"</span><span style="color: #800000;">Not Found</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">133</span> <span style="color: #0000ff;">char</span> tyhp_noimplemented[] =     <span style="color: #800000;">"</span><span style="color: #800000;">No Implemented</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">134</span> 
<span style="color: #008080;">135</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">136</span> <span style="color: #008000;"> *函数作用：通过HTTP状态码返回友好语句
</span><span style="color: #008080;">137</span> <span style="color: #008000;"> *函数参数：HTTP状态码
</span><span style="color: #008080;">138</span> <span style="color: #008000;"> *函数返回值: 相应的语句
</span><span style="color: #008080;">139</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">140</span> <span style="color: #0000ff;">char</span> *tyhp_get_state_by_codes(<span style="color: #0000ff;">int</span><span style="color: #000000;"> http_codes);
</span><span style="color: #008080;">141</span> <span style="color: #008000;">/*</span><span style="color: #008000;">*****************************************************************************
</span><span style="color: #008080;">142</span> <span style="color: #008000;">***********</span><span style="color: #008000;">*/</span>
<span style="color: #008080;">143</span> 
<span style="color: #008080;">144</span> <span style="color: #008000;">/*</span><span style="color: #008000;">**********************************  HTTP响应首部  
</span><span style="color: #008080;">145</span> <span style="color: #008000;">******************************************</span><span style="color: #008000;">*/</span>
<span style="color: #008080;">146</span> <span style="color: #0000ff;">#define</span> TYHP_ACCEPTRANGE_HEAD            "Accpet-Range"
<span style="color: #008080;">147</span> <span style="color: #0000ff;">#define</span>    TYHP_AGE_HEAD                     "Age"
<span style="color: #008080;">148</span> <span style="color: #0000ff;">#define</span>    TYHP_ALLOW_HEAD                    "Allow"
<span style="color: #008080;">149</span> <span style="color: #0000ff;">#define</span>    TYHP_CONTENTBASE_HEAD            "Content-Base"
<span style="color: #008080;">150</span> <span style="color: #0000ff;">#define</span>    TYHP_CONTENTLENGTH_HEAD            "Content-Length"
<span style="color: #008080;">151</span> <span style="color: #0000ff;">#define</span>    TYHP_CONTENTLOCATION_HEAD        "Content-Location"
<span style="color: #008080;">152</span> <span style="color: #0000ff;">#define</span>    TYHP_CONTENTRANGE_HEAD            "Content-Range"
<span style="color: #008080;">153</span> <span style="color: #0000ff;">#define</span>    TYHP_CONTENTTYPE_HEAD            "Content-Type"
<span style="color: #008080;">154</span> <span style="color: #0000ff;">#define</span>    TYHP_DATE_HEAD                    "Date"
<span style="color: #008080;">155</span> <span style="color: #0000ff;">#define</span>    TYHP_EXPIRES_HEAD                "Expires"
<span style="color: #008080;">156</span> <span style="color: #0000ff;">#define</span>    TYHP_LAST_MODIFIED_HEAD            "Last-Modified"
<span style="color: #008080;">157</span> <span style="color: #0000ff;">#define</span>    TYHP_LOCATION_HEAD                 "Location"
<span style="color: #008080;">158</span> <span style="color: #0000ff;">#define</span>    TYHP_PUBLIC_HEAD                "Public"
<span style="color: #008080;">159</span> <span style="color: #0000ff;">#define</span> TYHP_RANGE_HEAD                 "Range"
<span style="color: #008080;">160</span> <span style="color: #0000ff;">#define</span>    TYHP_SERVER_HEAD                "Server"
<span style="color: #008080;">161</span> <span style="color: #008000;">/*</span><span style="color: #008000;">*****************************************************************************
</span><span style="color: #008080;">162</span> <span style="color: #008000;">***********</span><span style="color: #008000;">*/</span>
<span style="color: #008080;">163</span> <span style="color: #008000;">/*</span><span style="color: #008000;">**********************************  HTTP请求首部  
</span><span style="color: #008080;">164</span> <span style="color: #008000;">******************************************</span><span style="color: #008000;">*/</span>
<span style="color: #008080;">165</span> <span style="color: #008000;">//</span><span style="color: #008000;">#define TYHP</span>
<span style="color: #008080;">166</span> <span style="color: #008000;">/*</span><span style="color: #008000;">*****************************************************************************
</span><span style="color: #008080;">167</span> <span style="color: #008000;">***********</span><span style="color: #008000;">*/</span>
<span style="color: #008080;">168</span> 
<span style="color: #008080;">169</span> <span style="color: #0000ff;">#endif</span></pre>
</div>
<div class="cnblogs_code">
<pre><span style="color: #008080;">  1</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">  2</span> <span style="color: #008000;">*Author        Zou Xiao hang
</span><span style="color: #008080;">  3</span> <span style="color: #008000;">*Email        1210603696@qq.com
</span><span style="color: #008080;">  4</span> <span style="color: #008000;">*File Name    tinyhttp.cpp
</span><span style="color: #008080;">  5</span> <span style="color: #008000;">*Date         2013/10/05
</span><span style="color: #008080;">  6</span> <span style="color: #008000;">*/</span>
<span style="color: #008080;">  7</span> #include <span style="color: #800000;">"</span><span style="color: #800000;">tinyhttp.h</span><span style="color: #800000;">"</span>    
<span style="color: #008080;">  8</span> 
<span style="color: #008080;">  9</span> <span style="color: #0000ff;">#define</span> ONEKILO        1024
<span style="color: #008080;"> 10</span> <span style="color: #0000ff;">#define</span> ONEMEGA        1024*ONEKILO
<span style="color: #008080;"> 11</span> <span style="color: #0000ff;">#define</span> ONEGIGA        1024*ONEMEGA
<span style="color: #008080;"> 12</span> 
<span style="color: #008080;"> 13</span> <span style="color: #008000;">/*</span><span style="color: #008000;">**********************************  线程相关  ******************************************</span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 14</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;"> 15</span> <span style="color: #008000;"> *函数作用：处理客户端链接的线程例程
</span><span style="color: #008080;"> 16</span> <span style="color: #008000;"> *函数参数：param为客户conn_sock
</span><span style="color: #008080;"> 17</span> <span style="color: #008000;"> *函数返回值: 无
</span><span style="color: #008080;"> 18</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 19</span> <span style="color: #0000ff;">void</span>* tyhp_thread_func(<span style="color: #0000ff;">void</span> *<span style="color: #000000;">param);
</span><span style="color: #008080;"> 20</span> 
<span style="color: #008080;"> 21</span> 
<span style="color: #008080;"> 22</span> <span style="color: #008000;">//</span><span style="color: #008000;">记录当前处理线程的数量</span>
<span style="color: #008080;"> 23</span> int32_t tyhp_thread_num = <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 24</span> pthread_mutex_t tyhp_thread_num_mutex =<span style="color: #000000;"> PTHREAD_MUTEX_INITIALIZER;
</span><span style="color: #008080;"> 25</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;"> 26</span> <span style="color: #008000;"> *函数作用：tyhp_thread_num原子加1
</span><span style="color: #008080;"> 27</span> <span style="color: #008000;"> *函数参数：无
</span><span style="color: #008080;"> 28</span> <span style="color: #008000;"> *函数返回值: 无
</span><span style="color: #008080;"> 29</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 30</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> tyhp_thread_num_add1();
</span><span style="color: #008080;"> 31</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;"> 32</span> <span style="color: #008000;"> *函数作用：tyhp_thread_num原子减1
</span><span style="color: #008080;"> 33</span> <span style="color: #008000;"> *函数参数：无
</span><span style="color: #008080;"> 34</span> <span style="color: #008000;"> *函数返回值: 无
</span><span style="color: #008080;"> 35</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 36</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> tyhp_thread_num_minus1();
</span><span style="color: #008080;"> 37</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;"> 38</span> <span style="color: #008000;"> *函数作用：tyhp_thread_num原子读
</span><span style="color: #008080;"> 39</span> <span style="color: #008000;"> *函数参数：无
</span><span style="color: #008080;"> 40</span> <span style="color: #008000;"> *函数返回值: tyhp_thread_num当前值
</span><span style="color: #008080;"> 41</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 42</span> <span style="color: #000000;"> int32_t tyhp_thread_num_read();
</span><span style="color: #008080;"> 43</span> <span style="color: #008000;">/*</span><span style="color: #008000;">***************************************************************************************</span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 44</span> 
<span style="color: #008080;"> 45</span> <span style="color: #008000;">/*</span><span style="color: #008000;">*******************************  tyhp_http_header_t处理函数  ********************************</span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 46</span>  <span style="color: #008000;">/*</span>
<span style="color: #008080;"> 47</span> <span style="color: #008000;"> *函数作用：根据解析下来的tyhp_http_header_t来处理客户的请求
</span><span style="color: #008080;"> 48</span> <span style="color: #008000;"> *函数参数：  phttphdr指向要处理的tyhp_http_header_t
</span><span style="color: #008080;"> 49</span> <span style="color: #008000;">             out保存了处理的结果，即http响应包
</span><span style="color: #008080;"> 50</span> <span style="color: #008000;"> *函数返回值: HTTP状态码
</span><span style="color: #008080;"> 51</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 52</span> <span style="color: #0000ff;">int</span> tyhp_do_http_header(tyhp_http_header_t *phttphdr, <span style="color: #0000ff;">string</span>&amp; <span style="color: #0000ff;">out</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 53</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;"> 54</span> <span style="color: #008000;"> *函数作用：通过HTTP状态码返回友好语句
</span><span style="color: #008080;"> 55</span> <span style="color: #008000;"> *函数参数：HTTP状态码
</span><span style="color: #008080;"> 56</span> <span style="color: #008000;"> *函数返回值: 相应的语句
</span><span style="color: #008080;"> 57</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 58</span> <span style="color: #0000ff;">char</span> *tyhp_get_state_by_codes(<span style="color: #0000ff;">int</span><span style="color: #000000;"> http_codes);
</span><span style="color: #008080;"> 59</span> <span style="color: #008000;">/*</span><span style="color: #008000;">***************************************************************************************</span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 60</span> 
<span style="color: #008080;"> 61</span> <span style="color: #008000;">/*</span><span style="color: #008000;">**********************************  web服务器程序入口函数  **************************************</span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 62</span> <span style="color: #0000ff;">int</span> main(<span style="color: #0000ff;">int</span> argc, <span style="color: #0000ff;">char</span> <span style="color: #0000ff;">const</span> *<span style="color: #000000;">argv[])
</span><span style="color: #008080;"> 63</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 64</span>     <span style="color: #0000ff;">int</span><span style="color: #000000;">                 listen_fd;
</span><span style="color: #008080;"> 65</span>     <span style="color: #0000ff;">int</span><span style="color: #000000;">                 conn_sock; 
</span><span style="color: #008080;"> 66</span>     <span style="color: #0000ff;">int</span><span style="color: #000000;">                 nfds;
</span><span style="color: #008080;"> 67</span>     <span style="color: #0000ff;">int</span><span style="color: #000000;">                 epollfd;
</span><span style="color: #008080;"> 68</span> <span style="color: #000000;">    uint16_t             listen_port;
</span><span style="color: #008080;"> 69</span>     <span style="color: #0000ff;">struct</span> servent         *<span style="color: #000000;">pservent;
</span><span style="color: #008080;"> 70</span>     <span style="color: #0000ff;">struct</span><span style="color: #000000;"> epoll_event     ev;
</span><span style="color: #008080;"> 71</span>     <span style="color: #0000ff;">struct</span><span style="color: #000000;"> epoll_event    events[MAX_EVENTS];
</span><span style="color: #008080;"> 72</span>     <span style="color: #0000ff;">struct</span><span style="color: #000000;"> sockaddr_in     server_addr;
</span><span style="color: #008080;"> 73</span>     <span style="color: #0000ff;">struct</span><span style="color: #000000;"> sockaddr_in    client_addr;
</span><span style="color: #008080;"> 74</span> <span style="color: #000000;">    socklen_t             addrlen;
</span><span style="color: #008080;"> 75</span> <span style="color: #000000;">    pthread_attr_t        pthread_attr_detach;
</span><span style="color: #008080;"> 76</span> <span style="color: #000000;">    _epollfd_connfd     epollfd_connfd;
</span><span style="color: #008080;"> 77</span> <span style="color: #000000;">    pthread_t             tid;
</span><span style="color: #008080;"> 78</span> 
<span style="color: #008080;"> 79</span>     <span style="color: #0000ff;">if</span>(argc != <span style="color: #800080;">2</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 80</span> <span style="color: #000000;">    {
</span><span style="color: #008080;"> 81</span>         printf(<span style="color: #800000;">"</span><span style="color: #800000;">Usage: %s &lt;config_path&gt;\n</span><span style="color: #800000;">"</span>, argv[<span style="color: #800080;">0</span><span style="color: #000000;">]);
</span><span style="color: #008080;"> 82</span>         exit(-<span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 83</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 84</span>     <span style="color: #008000;">//</span><span style="color: #008000;">判断配置文件是否存在</span>
<span style="color: #008080;"> 85</span>     <span style="color: #0000ff;">if</span>(-<span style="color: #800080;">1</span> == tyhp_is_file_existed(argv[<span style="color: #800080;">1</span><span style="color: #000000;">]))
</span><span style="color: #008080;"> 86</span> <span style="color: #000000;">    {
</span><span style="color: #008080;"> 87</span>         perror(<span style="color: #800000;">"</span><span style="color: #800000;">tyhp_is_file_existed</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 88</span>         exit(-<span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 89</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 90</span>     <span style="color: #008000;">//</span><span style="color: #008000;">调用tyhp_parse_config解析配置文件</span>
<span style="color: #008080;"> 91</span>     <span style="color: #0000ff;">if</span>(-<span style="color: #800080;">1</span> == tyhp_parse_config(argv[<span style="color: #800080;">1</span><span style="color: #000000;">]))
</span><span style="color: #008080;"> 92</span> <span style="color: #000000;">    {
</span><span style="color: #008080;"> 93</span>         printf(<span style="color: #800000;">"</span><span style="color: #800000;">tyhp_parse_config error\n</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 94</span>         exit(-<span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 95</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 96</span> 
<span style="color: #008080;"> 97</span>     <span style="color: #008000;">//</span><span style="color: #008000;">创建监听套接字</span>
<span style="color: #008080;"> 98</span>     listen_fd = tyhp_socket(AF_INET, SOCK_STREAM, <span style="color: #800080;">0</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 99</span>     <span style="color: #008000;">//</span><span style="color: #008000;">设置监听套接字为非阻塞模式</span>
<span style="color: #008080;">100</span> <span style="color: #000000;">    tyhp_set_nonblocking(listen_fd);
</span><span style="color: #008080;">101</span>     <span style="color: #008000;">//</span><span style="color: #008000;">对监听套接字设置SO_REUSEADDR选项</span>
<span style="color: #008080;">102</span> <span style="color: #000000;">    tyhp_set_reuse_addr(listen_fd);
</span><span style="color: #008080;">103</span>     <span style="color: #008000;">//</span><span style="color: #008000;">通过服务名和协议名获得相应的知名端口，其实可以直接设置端口为80，我们这样做是为了可扩展性</span>
<span style="color: #008080;">104</span>     pservent = tyhp_getservbyname(<span style="color: #800000;">"</span><span style="color: #800000;">http</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">tcp</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">105</span>     <span style="color: #008000;">//</span><span style="color: #008000;">pservent-&gt;s_port已经是网络字节序了</span>
<span style="color: #008080;">106</span>     listen_port = pservent-&gt;<span style="color: #000000;">s_port;
</span><span style="color: #008080;">107</span>     
<span style="color: #008080;">108</span>     bzero(&amp;server_addr, <span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(server_addr));
</span><span style="color: #008080;">109</span>     server_addr.sin_family =<span style="color: #000000;"> AF_INET;
</span><span style="color: #008080;">110</span>     server_addr.sin_port =<span style="color: #000000;"> (listen_port);
</span><span style="color: #008080;">111</span>     server_addr.sin_addr.s_addr =<span style="color: #000000;"> htonl(INADDR_ANY);
</span><span style="color: #008080;">112</span> 
<span style="color: #008080;">113</span>     <span style="color: #008000;">//</span><span style="color: #008000;">将服务器sockaddr_in与监听套接字绑定</span>
<span style="color: #008080;">114</span>     tyhp_bind(listen_fd, (<span style="color: #0000ff;">struct</span> sockaddr*)&amp;server_addr, <span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(server_addr));
</span><span style="color: #008080;">115</span>     <span style="color: #008000;">//</span><span style="color: #008000;">开始监听</span>
<span style="color: #008080;">116</span> <span style="color: #000000;">    tyhp_listen(listen_fd, MAX_BACKLOG);
</span><span style="color: #008080;">117</span>     
<span style="color: #008080;">118</span>     <span style="color: #008000;">//</span><span style="color: #008000;">创建epoll文件描述符</span>
<span style="color: #008080;">119</span>     epollfd =<span style="color: #000000;"> tyhp_epoll_create(MAX_EVENTS);
</span><span style="color: #008080;">120</span>     
<span style="color: #008080;">121</span>     ev.events = EPOLLIN;<span style="color: #008000;">//</span><span style="color: #008000;">可读事件</span>
<span style="color: #008080;">122</span>     ev.data.fd =<span style="color: #000000;"> listen_fd;
</span><span style="color: #008080;">123</span>     <span style="color: #008000;">//</span><span style="color: #008000;">将监听事件加入epoll中</span>
<span style="color: #008080;">124</span>     tyhp_epoll_ctl(epollfd, EPOLL_CTL_ADD, listen_fd, &amp;<span style="color: #000000;">ev);
</span><span style="color: #008080;">125</span> 
<span style="color: #008080;">126</span>     <span style="color: #008000;">//</span><span style="color: #008000;">设置线程属性为detach</span>
<span style="color: #008080;">127</span>     pthread_attr_init(&amp;<span style="color: #000000;">pthread_attr_detach);
</span><span style="color: #008080;">128</span>     pthread_attr_setdetachstate(&amp;<span style="color: #000000;">pthread_attr_detach, PTHREAD_CREATE_DETACHED);
</span><span style="color: #008080;">129</span>         
<span style="color: #008080;">130</span>     <span style="color: #0000ff;">for</span><span style="color: #000000;">(;;)
</span><span style="color: #008080;">131</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">132</span>         <span style="color: #008000;">//</span><span style="color: #008000;">无限等待直到有描述符就绪</span>
<span style="color: #008080;">133</span>         nfds = tyhp_epoll_wait(epollfd, events, MAX_EVENTS, -<span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;">134</span>         <span style="color: #008000;">//</span><span style="color: #008000;">若tyhp_epoll_wait被中断则重新调用该函数</span>
<span style="color: #008080;">135</span>         <span style="color: #0000ff;">if</span>(nfds == -<span style="color: #800080;">1</span> &amp;&amp; errno ==<span style="color: #000000;"> EINTR)
</span><span style="color: #008080;">136</span>             <span style="color: #0000ff;">continue</span><span style="color: #000000;">;
</span><span style="color: #008080;">137</span>             
<span style="color: #008080;">138</span>         <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> n = <span style="color: #800080;">0</span>; n != nfds; ++<span style="color: #000000;">n)
</span><span style="color: #008080;">139</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">140</span>             <span style="color: #008000;">//</span><span style="color: #008000;">处理监听套接字触发的事件</span>
<span style="color: #008080;">141</span>             <span style="color: #0000ff;">if</span>(events[n].data.fd ==<span style="color: #000000;"> listen_fd)
</span><span style="color: #008080;">142</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">143</span>                 conn_sock = tyhp_accept(listen_fd, (<span style="color: #0000ff;">struct</span> sockaddr*)&amp;client_addr, &amp;<span style="color: #000000;">addrlen);
</span><span style="color: #008080;">144</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">设置新链接上的套接字为非阻塞模式</span>
<span style="color: #008080;">145</span> <span style="color: #000000;">                tyhp_set_nonblocking(conn_sock);
</span><span style="color: #008080;">146</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">设置读事件和ET模式</span>
<span style="color: #008080;">147</span>                 ev.events = EPOLLIN |<span style="color: #000000;"> EPOLLET;
</span><span style="color: #008080;">148</span>                 ev.data.fd =<span style="color: #000000;"> conn_sock;
</span><span style="color: #008080;">149</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">将监听事件加入epoll中</span>
<span style="color: #008080;">150</span>                 tyhp_epoll_ctl(epollfd, EPOLL_CTL_ADD, conn_sock, &amp;<span style="color: #000000;">ev);
</span><span style="color: #008080;">151</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">152</span>             <span style="color: #0000ff;">else</span>
<span style="color: #008080;">153</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">154</span>                 epollfd_connfd.epollfd =<span style="color: #000000;"> epollfd;
</span><span style="color: #008080;">155</span>                 epollfd_connfd.connfd =<span style="color: #000000;"> events[n].data.fd;
</span><span style="color: #008080;">156</span>                 ev.data.fd =<span style="color: #000000;"> conn_sock;
</span><span style="color: #008080;">157</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">epoll不再监听这个客户端套接字</span>
<span style="color: #008080;">158</span>                 tyhp_epoll_ctl(epollfd, EPOLL_CTL_DEL, conn_sock, &amp;<span style="color: #000000;">ev);
</span><span style="color: #008080;">159</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">处理链接</span>
<span style="color: #008080;">160</span>                 pthread_create(&amp;tid, &amp;pthread_attr_detach, &amp;tyhp_thread_func, (<span style="color: #0000ff;">void</span>*)&amp;<span style="color: #000000;">epollfd_connfd);
</span><span style="color: #008080;">161</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">tyhp_thread_func((void*)&amp;epollfd_connfd);
</span><span style="color: #008080;">162</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">close(conn_sock);</span>
<span style="color: #008080;">163</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">164</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">165</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">166</span>     <span style="color: #008000;">//</span><span style="color: #008000;">清理工作</span>
<span style="color: #008080;">167</span>     pthread_attr_destroy(&amp;<span style="color: #000000;">pthread_attr_detach);
</span><span style="color: #008080;">168</span> 
<span style="color: #008080;">169</span>     <span style="color: #008000;">//</span><span style="color: #008000;">关闭监听套接字</span>
<span style="color: #008080;">170</span> <span style="color: #000000;">    close(listen_fd);
</span><span style="color: #008080;">171</span>     <span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">172</span> <span style="color: #000000;">}
</span><span style="color: #008080;">173</span> <span style="color: #008000;">/*</span><span style="color: #008000;">***************************************************************************************</span><span style="color: #008000;">*/</span>
<span style="color: #008080;">174</span> 
<span style="color: #008080;">175</span> <span style="color: #008000;">/*</span><span style="color: #008000;">**********************************  线程相关  ******************************************</span><span style="color: #008000;">*/</span>
<span style="color: #008080;">176</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">177</span> <span style="color: #008000;"> *函数作用：处理客户端链接的线程例程
</span><span style="color: #008080;">178</span> <span style="color: #008000;"> *函数参数：
</span><span style="color: #008080;">179</span> <span style="color: #008000;"> *函数返回值: NULL
</span><span style="color: #008080;">180</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">181</span>  <span style="color: #0000ff;">#define</span> TIMEOUT    1000*60*4 <span style="color: #008000;">//</span><span style="color: #008000;">设置超时 milliseconds</span>
<span style="color: #008080;">182</span> <span style="color: #0000ff;">void</span>* tyhp_thread_func(<span style="color: #0000ff;">void</span> *<span style="color: #000000;">param)
</span><span style="color: #008080;">183</span> <span style="color: #000000;">{
</span><span style="color: #008080;">184</span> <span style="color: #000000;">    tyhp_thread_num_add1();
</span><span style="color: #008080;">185</span> 
<span style="color: #008080;">186</span>     tyhp_http_header_t *phttphdr =<span style="color: #000000;"> tyhp_alloc_http_header();
</span><span style="color: #008080;">187</span> 
<span style="color: #008080;">188</span>     _epollfd_connfd *ptr_epollfd_connfd = (_epollfd_connfd*<span style="color: #000000;">)param;
</span><span style="color: #008080;">189</span>     <span style="color: #008000;">//</span><span style="color: #008000;">int epollfd = ptr_epollfd_connfd-&gt;epollfd;
</span><span style="color: #008080;">190</span>     <span style="color: #008000;">//</span><span style="color: #008000;">获取客户连接socket</span>
<span style="color: #008080;">191</span>     <span style="color: #0000ff;">int</span> conn_sock = ptr_epollfd_connfd-&gt;<span style="color: #000000;">connfd;
</span><span style="color: #008080;">192</span> 
<span style="color: #008080;">193</span>     <span style="color: #0000ff;">struct</span> epoll_event ev, events[<span style="color: #800080;">2</span><span style="color: #000000;">];
</span><span style="color: #008080;">194</span>     ev.events = EPOLLIN |<span style="color: #000000;"> EPOLLET;
</span><span style="color: #008080;">195</span>     ev.data.fd =<span style="color: #000000;"> conn_sock;
</span><span style="color: #008080;">196</span>     <span style="color: #008000;">//</span><span style="color: #008000;">针对客户链接的新epollfd</span>
<span style="color: #008080;">197</span>     <span style="color: #0000ff;">int</span> epollfd = tyhp_epoll_create(<span style="color: #800080;">2</span><span style="color: #000000;">);
</span><span style="color: #008080;">198</span>     tyhp_epoll_ctl(epollfd, EPOLL_CTL_ADD, ev.data.fd, &amp;<span style="color: #000000;">ev);
</span><span style="color: #008080;">199</span>     <span style="color: #0000ff;">int</span> nfds = <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">200</span> 
<span style="color: #008080;">201</span>     pthread_t tid =<span style="color: #000000;"> pthread_self();
</span><span style="color: #008080;">202</span>     printf(<span style="color: #800000;">"</span><span style="color: #800000;">NO.%u thread runs now !!!\n</span><span style="color: #800000;">"</span>, (unsigned <span style="color: #0000ff;">int</span><span style="color: #000000;">)tid);
</span><span style="color: #008080;">203</span>     
<span style="color: #008080;">204</span>     <span style="color: #008000;">//</span><span style="color: #008000;">Nginx默认http请求包大小为1M，所以我也分配1M缓存来存http请求包</span>
<span style="color: #008080;">205</span>     <span style="color: #0000ff;">char</span> *buff = (<span style="color: #0000ff;">char</span>*<span style="color: #000000;">)tyhp_malloc(ONEMEGA);
</span><span style="color: #008080;">206</span> <span style="color: #000000;">    bzero(buff, ONEMEGA);
</span><span style="color: #008080;">207</span> 
<span style="color: #008080;">208</span>     <span style="color: #008000;">//</span><span style="color: #008000;">关闭connfd的Nagle算法</span>
<span style="color: #008080;">209</span> <span style="color: #000000;">    tyhp_set_off_tcp_nagle(conn_sock);
</span><span style="color: #008080;">210</span>     <span style="color: #008000;">//</span><span style="color: #008000;">设置接收超时时间为60秒</span>
<span style="color: #008080;">211</span>     tyhp_set_recv_timeo(conn_sock, <span style="color: #800080;">60</span>, <span style="color: #800080;">0</span><span style="color: #000000;">);
</span><span style="color: #008080;">212</span>     <span style="color: #008000;">//</span><span style="color: #008000;">设置发送超时时间为120秒
</span><span style="color: #008080;">213</span>     <span style="color: #008000;">//</span><span style="color: #008000;">tyhp_set_snd_timeo(connfd, 120, 0);</span>
<span style="color: #008080;">214</span> <span style="color: #000000;">begin:
</span><span style="color: #008080;">215</span>     int32_t nread = <span style="color: #800080;">0</span>, n = <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">216</span>     <span style="color: #0000ff;">for</span><span style="color: #000000;">(;;)
</span><span style="color: #008080;">217</span> <span style="color: #000000;">    {    
</span><span style="color: #008080;">218</span>         <span style="color: #0000ff;">if</span>((n = read(conn_sock, buff+nread, ONEMEGA-<span style="color: #800080;">1</span>)) &gt; <span style="color: #800080;">0</span><span style="color: #000000;">)
</span><span style="color: #008080;">219</span>             nread +=<span style="color: #000000;"> n;
</span><span style="color: #008080;">220</span>         <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span>(<span style="color: #800080;">0</span> ==<span style="color: #000000;"> n)
</span><span style="color: #008080;">221</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;">222</span>         <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span>(-<span style="color: #800080;">1</span> == n &amp;&amp; errno ==<span style="color: #000000;"> EINTR)
</span><span style="color: #008080;">223</span>             <span style="color: #0000ff;">continue</span><span style="color: #000000;">;
</span><span style="color: #008080;">224</span>         <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span>(-<span style="color: #800080;">1</span> == n &amp;&amp; errno ==<span style="color: #000000;"> EAGAIN)
</span><span style="color: #008080;">225</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;">226</span>         <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span>(-<span style="color: #800080;">1</span> == n &amp;&amp; errno ==<span style="color: #000000;"> EWOULDBLOCK)
</span><span style="color: #008080;">227</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">228</span>             perror(<span style="color: #800000;">"</span><span style="color: #800000;">socket read timeout</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">229</span>             <span style="color: #0000ff;">goto</span> <span style="color: #0000ff;">out</span><span style="color: #000000;">;
</span><span style="color: #008080;">230</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">231</span>         <span style="color: #0000ff;">else</span>
<span style="color: #008080;">232</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">233</span>             perror(<span style="color: #800000;">"</span><span style="color: #800000;">read http request error</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">234</span> <span style="color: #000000;">            tyhp_free(buff);
</span><span style="color: #008080;">235</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;">236</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">237</span>         
<span style="color: #008080;">238</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">239</span> 
<span style="color: #008080;">240</span>     <span style="color: #0000ff;">if</span>(<span style="color: #800080;">0</span> !=<span style="color: #000000;"> nread)
</span><span style="color: #008080;">241</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">242</span>         <span style="color: #0000ff;">string</span> str_http_request(buff, buff +<span style="color: #000000;"> nread);
</span><span style="color: #008080;">243</span> 
<span style="color: #008080;">244</span>         <span style="color: #008000;">//</span><span style="color: #008000;">do_something(str_http_request);</span>
<span style="color: #008080;">245</span>         <span style="color: #0000ff;">if</span>(!<span style="color: #000000;">tyhp_parse_http_request(str_http_request, phttphdr))
</span><span style="color: #008080;">246</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">247</span>             perror(<span style="color: #800000;">"</span><span style="color: #800000;">tyhp_parse_http_request: parse str_http_request failed</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">248</span>             <span style="color: #0000ff;">goto</span> <span style="color: #0000ff;">out</span><span style="color: #000000;">;
</span><span style="color: #008080;">249</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">250</span>         cout&lt;&lt;<span style="color: #800000;">"</span><span style="color: #800000;">解析出来的http请求包:</span><span style="color: #800000;">"</span>&lt;&lt;<span style="color: #000000;">endl;
</span><span style="color: #008080;">251</span> <span style="color: #000000;">        tyhp_print_http_header(phttphdr);
</span><span style="color: #008080;">252</span> 
<span style="color: #008080;">253</span>         <span style="color: #0000ff;">string</span> <span style="color: #0000ff;">out</span><span style="color: #000000;">;
</span><span style="color: #008080;">254</span>         <span style="color: #0000ff;">int</span> http_codes = tyhp_do_http_header(phttphdr, <span style="color: #0000ff;">out</span><span style="color: #000000;">);
</span><span style="color: #008080;">255</span> 
<span style="color: #008080;">256</span>         <span style="color: #008000;">/*</span><span style="color: #008000;">***** debug ****</span><span style="color: #008000;">*/</span>
<span style="color: #008080;">257</span>         cout&lt;&lt;<span style="color: #800000;">"</span><span style="color: #800000;">http响应包:</span><span style="color: #800000;">"</span>&lt;&lt;endl&lt;&lt;<span style="color: #0000ff;">out</span>&lt;&lt;<span style="color: #000000;">endl;
</span><span style="color: #008080;">258</span> 
<span style="color: #008080;">259</span>         <span style="color: #0000ff;">char</span> *out_buf = (<span style="color: #0000ff;">char</span> *)tyhp_malloc(<span style="color: #0000ff;">out</span><span style="color: #000000;">.size());
</span><span style="color: #008080;">260</span>         <span style="color: #0000ff;">if</span>(out_buf ==<span style="color: #000000;"> NULL)
</span><span style="color: #008080;">261</span>             <span style="color: #0000ff;">goto</span> <span style="color: #0000ff;">out</span><span style="color: #000000;">;
</span><span style="color: #008080;">262</span>         <span style="color: #0000ff;">int</span><span style="color: #000000;"> i;
</span><span style="color: #008080;">263</span>         <span style="color: #0000ff;">for</span>(i = <span style="color: #800080;">0</span>; i != <span style="color: #0000ff;">out</span>.size(); ++<span style="color: #000000;">i)
</span><span style="color: #008080;">264</span>             out_buf[i] = <span style="color: #0000ff;">out</span><span style="color: #000000;">[i];
</span><span style="color: #008080;">265</span>         out_buf[i] = <span style="color: #800000;">'</span><span style="color: #800000;">\0</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">266</span>         <span style="color: #0000ff;">int</span> nwrite = <span style="color: #800080;">0</span>; n = <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">267</span>         <span style="color: #0000ff;">if</span>( http_codes == TYHP_BADREQUEST         || 
<span style="color: #008080;">268</span>             http_codes == TYHP_NOIMPLEMENTED     ||
<span style="color: #008080;">269</span>             http_codes == TYHP_NOTFOUND         ||
<span style="color: #008080;">270</span>             (http_codes == TYHP_OK &amp;&amp; phttphdr-&gt;method == <span style="color: #800000;">"</span><span style="color: #800000;">HEAD</span><span style="color: #800000;">"</span><span style="color: #000000;">))
</span><span style="color: #008080;">271</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">272</span>             <span style="color: #0000ff;">while</span>((n = write(conn_sock, out_buf + nwrite, i)) != <span style="color: #800080;">0</span><span style="color: #000000;">)
</span><span style="color: #008080;">273</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">274</span>                 <span style="color: #0000ff;">if</span>(n == -<span style="color: #800080;">1</span> &amp;&amp; errno ==<span style="color: #000000;"> EINTR)
</span><span style="color: #008080;">275</span>                     <span style="color: #0000ff;">continue</span><span style="color: #000000;">;
</span><span style="color: #008080;">276</span>                 <span style="color: #0000ff;">else</span>
<span style="color: #008080;">277</span>                     <span style="color: #0000ff;">goto</span> <span style="color: #0000ff;">out</span><span style="color: #000000;">;
</span><span style="color: #008080;">278</span>                 nwrite +=<span style="color: #000000;"> n;
</span><span style="color: #008080;">279</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">280</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">281</span>         <span style="color: #0000ff;">if</span>(http_codes ==<span style="color: #000000;"> TYHP_OK)
</span><span style="color: #008080;">282</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">283</span>             <span style="color: #0000ff;">if</span>(phttphdr-&gt;method == <span style="color: #800000;">"</span><span style="color: #800000;">GET</span><span style="color: #800000;">"</span><span style="color: #000000;">)
</span><span style="color: #008080;">284</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">285</span>                 <span style="color: #0000ff;">while</span>((n = write(conn_sock, out_buf + nwrite, i)) != <span style="color: #800080;">0</span><span style="color: #000000;">)
</span><span style="color: #008080;">286</span> <span style="color: #000000;">                {
</span><span style="color: #008080;">287</span>                     cout&lt;&lt;n&lt;&lt;<span style="color: #000000;">endl;
</span><span style="color: #008080;">288</span>                     <span style="color: #0000ff;">if</span>(n == -<span style="color: #800080;">1</span> &amp;&amp; errno ==<span style="color: #000000;"> EINTR)
</span><span style="color: #008080;">289</span>                         <span style="color: #0000ff;">continue</span><span style="color: #000000;">;
</span><span style="color: #008080;">290</span>                     <span style="color: #0000ff;">else</span>
<span style="color: #008080;">291</span>                         <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;">292</span>                     nwrite +=<span style="color: #000000;"> n;
</span><span style="color: #008080;">293</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">294</span>                 <span style="color: #0000ff;">string</span> real_url = tyhp_make_real_url(phttphdr-&gt;<span style="color: #000000;">url);
</span><span style="color: #008080;">295</span>                 <span style="color: #0000ff;">int</span> fd =<span style="color: #000000;"> open(real_url.c_str(), O_RDONLY);
</span><span style="color: #008080;">296</span>                 <span style="color: #0000ff;">int</span> file_size =<span style="color: #000000;"> tyhp_get_file_length(real_url.c_str());
</span><span style="color: #008080;">297</span>                 cout&lt;&lt;<span style="color: #800000;">"</span><span style="color: #800000;">file size </span><span style="color: #800000;">"</span>&lt;&lt;file_size&lt;&lt;<span style="color: #000000;">endl;
</span><span style="color: #008080;">298</span>                 <span style="color: #0000ff;">int</span> nwrite = <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">299</span>                 cout&lt;&lt;<span style="color: #800000;">"</span><span style="color: #800000;">sendfile : </span><span style="color: #800000;">"</span>&lt;&lt;real_url.c_str()&lt;&lt;<span style="color: #000000;">endl;
</span><span style="color: #008080;">300</span> <span style="color: #000000;">            again:
</span><span style="color: #008080;">301</span>                 <span style="color: #0000ff;">if</span>((sendfile(conn_sock, fd, (off_t*)&amp;nwrite, file_size)) &lt; <span style="color: #800080;">0</span><span style="color: #000000;">)
</span><span style="color: #008080;">302</span>                     perror(<span style="color: #800000;">"</span><span style="color: #800000;">sendfile</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">303</span>                 <span style="color: #0000ff;">if</span>(nwrite &lt;<span style="color: #000000;"> file_size)
</span><span style="color: #008080;">304</span>                     <span style="color: #0000ff;">goto</span><span style="color: #000000;"> again;
</span><span style="color: #008080;">305</span>                 cout&lt;&lt;<span style="color: #800000;">"</span><span style="color: #800000;">sendfile ok:</span><span style="color: #800000;">"</span>&lt;&lt;nwrite&lt;&lt;<span style="color: #000000;">endl;
</span><span style="color: #008080;">306</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">307</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">308</span> <span style="color: #000000;">        free(out_buf);
</span><span style="color: #008080;">309</span>         <span style="color: #008000;">//</span><span style="color: #008000;">超时4分钟</span>
<span style="color: #008080;">310</span>         nfds = tyhp_epoll_wait(epollfd, events, <span style="color: #800080;">2</span><span style="color: #000000;">, TIMEOUT);
</span><span style="color: #008080;">311</span>         <span style="color: #0000ff;">if</span>(<span style="color: #800080;">0</span> == nfds)<span style="color: #008000;">//</span><span style="color: #008000;">timeout</span>
<span style="color: #008080;">312</span>             <span style="color: #0000ff;">goto</span> <span style="color: #0000ff;">out</span><span style="color: #000000;">;
</span><span style="color: #008080;">313</span>         <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i = <span style="color: #800080;">0</span>; i &lt; nfds; ++<span style="color: #000000;">i)
</span><span style="color: #008080;">314</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">315</span>             <span style="color: #0000ff;">if</span>(events[i].data.fd ==<span style="color: #000000;"> conn_sock)
</span><span style="color: #008080;">316</span>                 <span style="color: #0000ff;">goto</span><span style="color: #000000;"> begin;
</span><span style="color: #008080;">317</span>             <span style="color: #0000ff;">else</span>
<span style="color: #008080;">318</span>                 <span style="color: #0000ff;">goto</span> <span style="color: #0000ff;">out</span><span style="color: #000000;">;
</span><span style="color: #008080;">319</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">320</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">321</span> 
<span style="color: #008080;">322</span> <span style="color: #0000ff;">out</span><span style="color: #000000;">:
</span><span style="color: #008080;">323</span> <span style="color: #000000;">    tyhp_free_http_header(phttphdr);
</span><span style="color: #008080;">324</span> <span style="color: #000000;">    close(conn_sock);
</span><span style="color: #008080;">325</span> <span style="color: #000000;">    tyhp_thread_num_minus1();
</span><span style="color: #008080;">326</span>     printf(<span style="color: #800000;">"</span><span style="color: #800000;">NO.%u thread ends now ~~~\n</span><span style="color: #800000;">"</span>, (unsigned <span style="color: #0000ff;">int</span><span style="color: #000000;">)tid);
</span><span style="color: #008080;">327</span> <span style="color: #000000;">}
</span><span style="color: #008080;">328</span> 
<span style="color: #008080;">329</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">330</span> <span style="color: #008000;"> *函数作用：tyhp_thread_num原子加1
</span><span style="color: #008080;">331</span> <span style="color: #008000;"> *函数参数：无
</span><span style="color: #008080;">332</span> <span style="color: #008000;"> *函数返回值: 无
</span><span style="color: #008080;">333</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">334</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> tyhp_thread_num_add1()
</span><span style="color: #008080;">335</span> <span style="color: #000000;">{
</span><span style="color: #008080;">336</span>     pthread_mutex_lock(&amp;<span style="color: #000000;">tyhp_thread_num_mutex);
</span><span style="color: #008080;">337</span>     ++<span style="color: #000000;">tyhp_thread_num;
</span><span style="color: #008080;">338</span>     pthread_mutex_unlock(&amp;<span style="color: #000000;">tyhp_thread_num_mutex);
</span><span style="color: #008080;">339</span> <span style="color: #000000;">}
</span><span style="color: #008080;">340</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">341</span> <span style="color: #008000;"> *函数作用：tyhp_thread_num原子减1
</span><span style="color: #008080;">342</span> <span style="color: #008000;"> *函数参数：无
</span><span style="color: #008080;">343</span> <span style="color: #008000;"> *函数返回值: 无
</span><span style="color: #008080;">344</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">345</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> tyhp_thread_num_minus1()
</span><span style="color: #008080;">346</span> <span style="color: #000000;">{
</span><span style="color: #008080;">347</span>     pthread_mutex_lock(&amp;<span style="color: #000000;">tyhp_thread_num_mutex);
</span><span style="color: #008080;">348</span>     --<span style="color: #000000;">tyhp_thread_num;
</span><span style="color: #008080;">349</span>     pthread_mutex_unlock(&amp;<span style="color: #000000;">tyhp_thread_num_mutex);
</span><span style="color: #008080;">350</span> <span style="color: #000000;">}
</span><span style="color: #008080;">351</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">352</span> <span style="color: #008000;"> *函数作用：tyhp_thread_num原子读
</span><span style="color: #008080;">353</span> <span style="color: #008000;"> *函数参数：无
</span><span style="color: #008080;">354</span> <span style="color: #008000;"> *函数返回值: tyhp_thread_num当前值
</span><span style="color: #008080;">355</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">356</span> <span style="color: #000000;"> int32_t tyhp_thread_num_read();
</span><span style="color: #008080;">357</span>  <span style="color: #008000;">/*</span><span style="color: #008000;">***************************************************************************************</span><span style="color: #008000;">*/</span>
<span style="color: #008080;">358</span> 
<span style="color: #008080;">359</span>  <span style="color: #008000;">/*</span><span style="color: #008000;">*******************************  tyhp_http_header_t处理函数  ********************************</span><span style="color: #008000;">*/</span>
<span style="color: #008080;">360</span>  <span style="color: #008000;">/*</span>
<span style="color: #008080;">361</span> <span style="color: #008000;"> *函数作用：根据解析下来的tyhp_http_header_t来处理客户的请求
</span><span style="color: #008080;">362</span> <span style="color: #008000;"> *函数参数：  phttphdr指向要处理的tyhp_http_header_t
</span><span style="color: #008080;">363</span> <span style="color: #008000;">             out保存了处理的结果，即http响应包
</span><span style="color: #008080;">364</span> <span style="color: #008000;"> *函数返回值: HTTP状态码
</span><span style="color: #008080;">365</span> 
<span style="color: #008080;">366</span> <span style="color: #008000;"> *目前支持的请求首部：
</span><span style="color: #008080;">367</span> <span style="color: #008000;"> *目前支持的响应首部：Date，Content-Base，Content-Length，Content-Location
</span><span style="color: #008080;">368</span> <span style="color: #008000;">                         Last-Modified，Public，Server
</span><span style="color: #008080;">369</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">370</span> <span style="color: #0000ff;">int</span> tyhp_do_http_header(tyhp_http_header_t *phttphdr, <span style="color: #0000ff;">string</span>&amp; <span style="color: #0000ff;">out</span><span style="color: #000000;">)
</span><span style="color: #008080;">371</span> <span style="color: #000000;">{
</span><span style="color: #008080;">372</span>     <span style="color: #0000ff;">char</span> status_line[<span style="color: #800080;">256</span>] = {<span style="color: #800080;">0</span><span style="color: #000000;">};
</span><span style="color: #008080;">373</span>     <span style="color: #0000ff;">string</span> crlf(<span style="color: #800000;">"</span><span style="color: #800000;">\r\n</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">374</span>     <span style="color: #0000ff;">string</span> server(<span style="color: #800000;">"</span><span style="color: #800000;">Server: tinyhttp\r\n</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">375</span>     <span style="color: #0000ff;">string</span> Public(<span style="color: #800000;">"</span><span style="color: #800000;">Public: GET, HEAD\r\n</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">376</span>     <span style="color: #0000ff;">string</span> content_base = <span style="color: #800000;">"</span><span style="color: #800000;">Content-Base: </span><span style="color: #800000;">"</span> + tyhp_domain +<span style="color: #000000;"> crlf;
</span><span style="color: #008080;">377</span>     <span style="color: #0000ff;">string</span> date = <span style="color: #800000;">"</span><span style="color: #800000;">Date:</span><span style="color: #800000;">"</span> + tyhp_time_gmt() +<span style="color: #000000;"> crlf;
</span><span style="color: #008080;">378</span> 
<span style="color: #008080;">379</span>     <span style="color: #0000ff;">string</span> content_length(<span style="color: #800000;">"</span><span style="color: #800000;">Content-Length: </span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">380</span>     <span style="color: #0000ff;">string</span> content_location(<span style="color: #800000;">"</span><span style="color: #800000;">Content-Location: </span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">381</span>     <span style="color: #0000ff;">string</span> last_modified(<span style="color: #800000;">"</span><span style="color: #800000;">Last-Modified: </span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">382</span>     <span style="color: #008000;">//</span><span style="color: #008000;">string body("");</span>
<span style="color: #008080;">383</span> 
<span style="color: #008080;">384</span>     <span style="color: #0000ff;">if</span>(phttphdr ==<span style="color: #000000;"> NULL)
</span><span style="color: #008080;">385</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">386</span>         snprintf(status_line, <span style="color: #0000ff;">sizeof</span>(status_line), <span style="color: #800000;">"</span><span style="color: #800000;">HTTP/1.1 %d %s\r\n</span><span style="color: #800000;">"</span><span style="color: #000000;">, 
</span><span style="color: #008080;">387</span> <span style="color: #000000;">            TYHP_BADREQUEST, tyhp_get_state_by_codes(TYHP_BADREQUEST));
</span><span style="color: #008080;">388</span>         <span style="color: #0000ff;">out</span> = status_line +<span style="color: #000000;"> crlf;
</span><span style="color: #008080;">389</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> TYHP_BADREQUEST;
</span><span style="color: #008080;">390</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">391</span> 
<span style="color: #008080;">392</span>     <span style="color: #0000ff;">string</span> method = phttphdr-&gt;<span style="color: #000000;">method;
</span><span style="color: #008080;">393</span>     <span style="color: #0000ff;">string</span> real_url = tyhp_make_real_url(phttphdr-&gt;<span style="color: #000000;">url);
</span><span style="color: #008080;">394</span>     <span style="color: #0000ff;">string</span> version = phttphdr-&gt;<span style="color: #000000;">version;
</span><span style="color: #008080;">395</span>     <span style="color: #0000ff;">if</span>(method == <span style="color: #800000;">"</span><span style="color: #800000;">GET</span><span style="color: #800000;">"</span> || method == <span style="color: #800000;">"</span><span style="color: #800000;">HEAD</span><span style="color: #800000;">"</span><span style="color: #000000;">)
</span><span style="color: #008080;">396</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">397</span>         <span style="color: #0000ff;">if</span>(tyhp_is_file_existed(real_url.c_str()) == -<span style="color: #800080;">1</span><span style="color: #000000;">)
</span><span style="color: #008080;">398</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">399</span>             snprintf(status_line, <span style="color: #0000ff;">sizeof</span>(status_line), <span style="color: #800000;">"</span><span style="color: #800000;">HTTP/1.1 %d %s\r\n</span><span style="color: #800000;">"</span><span style="color: #000000;">, 
</span><span style="color: #008080;">400</span> <span style="color: #000000;">                TYHP_NOTFOUND, tyhp_get_state_by_codes(TYHP_NOTFOUND));
</span><span style="color: #008080;">401</span>             <span style="color: #0000ff;">out</span> += (status_line + server + date +<span style="color: #000000;"> crlf); 
</span><span style="color: #008080;">402</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> TYHP_NOTFOUND;
</span><span style="color: #008080;">403</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">404</span>         <span style="color: #0000ff;">else</span>
<span style="color: #008080;">405</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">406</span>             <span style="color: #0000ff;">int</span> len =<span style="color: #000000;"> tyhp_get_file_length(real_url.c_str());
</span><span style="color: #008080;">407</span>             snprintf(status_line, <span style="color: #0000ff;">sizeof</span>(status_line), <span style="color: #800000;">"</span><span style="color: #800000;">HTTP/1.1 %d %s\r\n</span><span style="color: #800000;">"</span><span style="color: #000000;">, 
</span><span style="color: #008080;">408</span> <span style="color: #000000;">                TYHP_OK, tyhp_get_state_by_codes(TYHP_OK));
</span><span style="color: #008080;">409</span>             <span style="color: #0000ff;">out</span> +=<span style="color: #000000;"> status_line;
</span><span style="color: #008080;">410</span>             snprintf(status_line, <span style="color: #0000ff;">sizeof</span>(status_line), <span style="color: #800000;">"</span><span style="color: #800000;">%d\r\n</span><span style="color: #800000;">"</span><span style="color: #000000;">, len);
</span><span style="color: #008080;">411</span>             <span style="color: #0000ff;">out</span> += content_length +<span style="color: #000000;"> status_line;
</span><span style="color: #008080;">412</span>             <span style="color: #0000ff;">out</span> += server + content_base +<span style="color: #000000;"> date;
</span><span style="color: #008080;">413</span>             <span style="color: #0000ff;">out</span> += last_modified + tyhp_get_file_modified_time(real_url.c_str()) + crlf +<span style="color: #000000;"> crlf;
</span><span style="color: #008080;">414</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">415</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">416</span>     <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span>(method == <span style="color: #800000;">"</span><span style="color: #800000;">PUT</span><span style="color: #800000;">"</span><span style="color: #000000;">)
</span><span style="color: #008080;">417</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">418</span>         snprintf(status_line, <span style="color: #0000ff;">sizeof</span>(status_line), <span style="color: #800000;">"</span><span style="color: #800000;">HTTP/1.1 %d %s\r\n</span><span style="color: #800000;">"</span><span style="color: #000000;">, 
</span><span style="color: #008080;">419</span> <span style="color: #000000;">                TYHP_NOIMPLEMENTED, tyhp_get_state_by_codes(TYHP_NOIMPLEMENTED));
</span><span style="color: #008080;">420</span>         <span style="color: #0000ff;">out</span> += status_line + server + Public + date +<span style="color: #000000;"> crlf;
</span><span style="color: #008080;">421</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> TYHP_NOIMPLEMENTED;
</span><span style="color: #008080;">422</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">423</span>     <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span>(method == <span style="color: #800000;">"</span><span style="color: #800000;">DELETE</span><span style="color: #800000;">"</span><span style="color: #000000;">)
</span><span style="color: #008080;">424</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">425</span>         snprintf(status_line, <span style="color: #0000ff;">sizeof</span>(status_line), <span style="color: #800000;">"</span><span style="color: #800000;">HTTP/1.1 %d %s\r\n</span><span style="color: #800000;">"</span><span style="color: #000000;">, 
</span><span style="color: #008080;">426</span> <span style="color: #000000;">                TYHP_NOIMPLEMENTED, tyhp_get_state_by_codes(TYHP_NOIMPLEMENTED));
</span><span style="color: #008080;">427</span>         <span style="color: #0000ff;">out</span> += status_line + server + Public + date +<span style="color: #000000;"> crlf;
</span><span style="color: #008080;">428</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> TYHP_NOIMPLEMENTED;
</span><span style="color: #008080;">429</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">430</span>     <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span>(method == <span style="color: #800000;">"</span><span style="color: #800000;">POST</span><span style="color: #800000;">"</span><span style="color: #000000;">)
</span><span style="color: #008080;">431</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">432</span>         snprintf(status_line, <span style="color: #0000ff;">sizeof</span>(status_line), <span style="color: #800000;">"</span><span style="color: #800000;">HTTP/1.1 %d %s\r\n</span><span style="color: #800000;">"</span><span style="color: #000000;">, 
</span><span style="color: #008080;">433</span> <span style="color: #000000;">                TYHP_NOIMPLEMENTED, tyhp_get_state_by_codes(TYHP_NOIMPLEMENTED));
</span><span style="color: #008080;">434</span>         <span style="color: #0000ff;">out</span> += status_line + server + Public + date +<span style="color: #000000;"> crlf;
</span><span style="color: #008080;">435</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> TYHP_NOIMPLEMENTED;
</span><span style="color: #008080;">436</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">437</span>     <span style="color: #0000ff;">else</span>
<span style="color: #008080;">438</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">439</span>         snprintf(status_line, <span style="color: #0000ff;">sizeof</span>(status_line), <span style="color: #800000;">"</span><span style="color: #800000;">HTTP/1.1 %d %s\r\n</span><span style="color: #800000;">"</span><span style="color: #000000;">, 
</span><span style="color: #008080;">440</span> <span style="color: #000000;">            TYHP_BADREQUEST, tyhp_get_state_by_codes(TYHP_BADREQUEST));
</span><span style="color: #008080;">441</span>         <span style="color: #0000ff;">out</span> = status_line +<span style="color: #000000;"> crlf;
</span><span style="color: #008080;">442</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> TYHP_BADREQUEST;
</span><span style="color: #008080;">443</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">444</span> 
<span style="color: #008080;">445</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> TYHP_OK;
</span><span style="color: #008080;">446</span> <span style="color: #000000;">}
</span><span style="color: #008080;">447</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">448</span> <span style="color: #008000;">#define TYHP_CONTINUE         100    //收到了请求的起始部分，客户端应该继续请求
</span><span style="color: #008080;">449</span> 
<span style="color: #008080;">450</span> <span style="color: #008000;">#define TYHP_OK                200    //服务器已经成功处理请求
</span><span style="color: #008080;">451</span> <span style="color: #008000;">#define TYHP_ACCEPTED        202    //请求已接受，服务器尚未处理
</span><span style="color: #008080;">452</span> 
<span style="color: #008080;">453</span> <span style="color: #008000;">#define TYHP_MOVED            301    //请求的URL已移走，响应应该包含Location URL
</span><span style="color: #008080;">454</span> <span style="color: #008000;">#define    TYHP_FOUND            302    //请求的URL临时移走，响应应该包含Location URL
</span><span style="color: #008080;">455</span> <span style="color: #008000;">#define TYHP_SEEOTHER        303    //告诉客户端应该用另一个URL获取资源，响应应该包含Location URL
</span><span style="color: #008080;">456</span> <span style="color: #008000;">#define TYHP_NOTMODIFIED    304    //资源未发生变化
</span><span style="color: #008080;">457</span> 
<span style="color: #008080;">458</span> <span style="color: #008000;">#define TYHP_BADREQUEST        400    //客户端发送了一条异常请求
</span><span style="color: #008080;">459</span> <span style="color: #008000;">#define TYHP_FORBIDDEN        403    //服务器拒绝请求
</span><span style="color: #008080;">460</span> <span style="color: #008000;">#define TYHP_NOTFOUND        404    //URL未找到
</span><span style="color: #008080;">461</span> 
<span style="color: #008080;">462</span> <span style="color: #008000;">#define TYHP_ERROR            500    //服务器出错
</span><span style="color: #008080;">463</span> <span style="color: #008000;">#define TYHP_NOIMPLEMENTED    501 //服务器不支持当前请求所需要的某个功能
</span><span style="color: #008080;">464</span> <span style="color: #008000;">#define TYHP_BADGATEWAY        502    //作为代理或网关使用的服务器遇到了来自响应链中上游的无效响应
</span><span style="color: #008080;">465</span> <span style="color: #008000;">#define TYHP_SRVUNAVAILABLE    503 //服务器目前无法提供请求服务，过一段时间后可以恢复
</span><span style="color: #008080;">466</span> 
<span style="color: #008080;">467</span> <span style="color: #008000;">/*
</span><span style="color: #008080;">468</span> <span style="color: #008000;"> *函数作用：通过HTTP状态码返回友好语句
</span><span style="color: #008080;">469</span> <span style="color: #008000;"> *函数参数：HTTP状态码
</span><span style="color: #008080;">470</span> <span style="color: #008000;"> *函数返回值: 相应的语句
</span><span style="color: #008080;">471</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">472</span> <span style="color: #0000ff;">char</span> *tyhp_get_state_by_codes(<span style="color: #0000ff;">int</span><span style="color: #000000;"> http_codes)
</span><span style="color: #008080;">473</span> <span style="color: #000000;">{
</span><span style="color: #008080;">474</span>     <span style="color: #0000ff;">switch</span><span style="color: #000000;"> (http_codes)
</span><span style="color: #008080;">475</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">476</span>         <span style="color: #0000ff;">case</span><span style="color: #000000;"> TYHP_OK:
</span><span style="color: #008080;">477</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> tyhp_ok;
</span><span style="color: #008080;">478</span>         <span style="color: #0000ff;">case</span><span style="color: #000000;"> TYHP_BADREQUEST:
</span><span style="color: #008080;">479</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> tyhp_badrequest;
</span><span style="color: #008080;">480</span>         <span style="color: #0000ff;">case</span><span style="color: #000000;"> TYHP_FORBIDDEN:
</span><span style="color: #008080;">481</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> tyhp_forbidden;
</span><span style="color: #008080;">482</span>         <span style="color: #0000ff;">case</span><span style="color: #000000;"> TYHP_NOTFOUND:
</span><span style="color: #008080;">483</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> tyhp_notfound;
</span><span style="color: #008080;">484</span>         <span style="color: #0000ff;">case</span><span style="color: #000000;"> TYHP_NOIMPLEMENTED:
</span><span style="color: #008080;">485</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> tyhp_noimplemented;
</span><span style="color: #008080;">486</span>         <span style="color: #0000ff;">default</span><span style="color: #000000;">:
</span><span style="color: #008080;">487</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;">488</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">489</span> 
<span style="color: #008080;">490</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> NULL;
</span><span style="color: #008080;">491</span> <span style="color: #000000;">}
</span><span style="color: #008080;">492</span> <span style="color: #008000;">/*</span><span style="color: #008000;">***************************************************************************************</span><span style="color: #008000;">*/</span></pre>
</div>
<div class="cnblogs_code">
<pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;"> 2</span> <span style="color: #008000;">*Author        Zou Xiao hang
</span><span style="color: #008080;"> 3</span> <span style="color: #008000;">*Email        1210603696@qq.com
</span><span style="color: #008080;"> 4</span> <span style="color: #008000;">*File Name    parse.cpp
</span><span style="color: #008080;"> 5</span> <span style="color: #008000;">*Date         2013/10/05
</span><span style="color: #008080;"> 6</span> <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 7</span> #include &lt;stdlib.h&gt;
<span style="color: #008080;"> 8</span> #include &lt;stdio.h&gt;
<span style="color: #008080;"> 9</span> #include &lt;<span style="color: #0000ff;">string</span>&gt;
<span style="color: #008080;">10</span> #include &lt;map&gt;
<span style="color: #008080;">11</span> #include &lt;utility&gt;
<span style="color: #008080;">12</span> #include &lt;sstream&gt;
<span style="color: #008080;">13</span> #include &lt;ctype.h&gt;
<span style="color: #008080;">14</span> #include &lt;iostream&gt;
<span style="color: #008080;">15</span> 
<span style="color: #008080;">16</span> <span style="color: #0000ff;">using</span> <span style="color: #0000ff;">namespace</span><span style="color: #000000;"> std;
</span><span style="color: #008080;">17</span> 
<span style="color: #008080;">18</span> typedef map&lt;<span style="color: #0000ff;">string</span>, <span style="color: #0000ff;">string</span>&gt;<span style="color: #000000;">     tyhp_header;
</span><span style="color: #008080;">19</span> 
<span style="color: #008080;">20</span> <span style="color: #008000;">//</span><span style="color: #008000;">#define string::npos            REQUEST_END</span>
<span style="color: #008080;">21</span> <span style="color: #0000ff;">#define</span> make_tyhp_header(key, value)    \
<span style="color: #008080;">22</span> <span style="color: #000000;">            make_pair((key), (value))    
</span><span style="color: #008080;">23</span> 
<span style="color: #008080;">24</span> <span style="color: #008000;">//</span><span style="color: #008000;">保存从http request解析下来的值</span>
<span style="color: #008080;">25</span> typedef <span style="color: #0000ff;">struct</span><span style="color: #000000;"> _tyhp_http_header_t
</span><span style="color: #008080;">26</span> <span style="color: #000000;">{
</span><span style="color: #008080;">27</span>     <span style="color: #0000ff;">string</span><span style="color: #000000;">         method;
</span><span style="color: #008080;">28</span>     <span style="color: #0000ff;">string</span><span style="color: #000000;">         url;
</span><span style="color: #008080;">29</span>     <span style="color: #0000ff;">string</span><span style="color: #000000;">        version;
</span><span style="color: #008080;">30</span> 
<span style="color: #008080;">31</span> <span style="color: #000000;">    tyhp_header header;
</span><span style="color: #008080;">32</span> 
<span style="color: #008080;">33</span>     <span style="color: #0000ff;">string</span><span style="color: #000000;">     body;
</span><span style="color: #008080;">34</span> <span style="color: #000000;">}tyhp_http_header_t;
</span><span style="color: #008080;">35</span> 
<span style="color: #008080;">36</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">37</span> <span style="color: #008000;"> *函数作用：打印tyhp_http_header_t里的header
</span><span style="color: #008080;">38</span> <span style="color: #008000;"> *函数参数：tyhp_header 的const 引用
</span><span style="color: #008080;">39</span> <span style="color: #008000;"> *函数返回值: 无
</span><span style="color: #008080;">40</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">41</span>  <span style="color: #0000ff;">void</span> tyhp_print_http_header_header(<span style="color: #0000ff;">const</span> tyhp_header&amp;<span style="color: #000000;"> head);
</span><span style="color: #008080;">42</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">43</span> <span style="color: #008000;"> *函数作用：打印tyhp_http_header_t
</span><span style="color: #008080;">44</span> <span style="color: #008000;"> *函数参数：tyhp_http_header_t指针
</span><span style="color: #008080;">45</span> <span style="color: #008000;"> *函数返回值: 无
</span><span style="color: #008080;">46</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">47</span>  <span style="color: #0000ff;">void</span> tyhp_print_http_header(tyhp_http_header_t *<span style="color: #000000;">phttphdr);
</span><span style="color: #008080;">48</span> 
<span style="color: #008080;">49</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">50</span> <span style="color: #008000;"> *函数作用：分配内存给tyhp_http_header_t
</span><span style="color: #008080;">51</span> <span style="color: #008000;"> *函数参数：无
</span><span style="color: #008080;">52</span> <span style="color: #008000;"> *函数返回值: NULL表示分配失败，其他值表示成功
</span><span style="color: #008080;">53</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">54</span> tyhp_http_header_t *<span style="color: #000000;">tyhp_alloc_http_header();
</span><span style="color: #008080;">55</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">56</span> <span style="color: #008000;"> *函数作用：回收分配给tyhp_http_header_t的内存
</span><span style="color: #008080;">57</span> <span style="color: #008000;"> *函数参数：tyhp_http_header_t指针
</span><span style="color: #008080;">58</span> <span style="color: #008000;"> *函数返回值: 无
</span><span style="color: #008080;">59</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">60</span> <span style="color: #0000ff;">void</span> tyhp_free_http_header(tyhp_http_header_t *<span style="color: #000000;">phttphdr);
</span><span style="color: #008080;">61</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">62</span> <span style="color: #008000;"> *函数作用：解析http_request
</span><span style="color: #008080;">63</span> <span style="color: #008000;"> *函数参数：http_request为待解析的值，phttphdr保存了解析下来的值
</span><span style="color: #008080;">64</span> <span style="color: #008000;"> *函数返回值: true表示解析成功，false表示解析失败
</span><span style="color: #008080;">65</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">66</span> <span style="color: #0000ff;">bool</span> tyhp_parse_http_request(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">string</span>&amp; http_request, tyhp_http_header_t *<span style="color: #000000;">phttphdr);
</span><span style="color: #008080;">67</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">68</span> <span style="color: #008000;"> *函数作用：根据key的值在phttphdr所指向的tyhp_http_header_t中查找相对应的值
</span><span style="color: #008080;">69</span> <span style="color: #008000;"> *函数参数：key为关键字，header
</span><span style="color: #008080;">70</span> <span style="color: #008000;"> *函数返回值: -返回空值表示查找失败，否则返回相应的值
</span><span style="color: #008080;">71</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">72</span> <span style="color: #0000ff;">string</span> tyhp_get_value_from_http_header(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">string</span>&amp; key, <span style="color: #0000ff;">const</span> tyhp_header&amp; header);</pre>
</div>
<div class="cnblogs_code">
<pre><span style="color: #008080;">  1</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">  2</span> <span style="color: #008000;">*Author        Zou Xiao hang
</span><span style="color: #008080;">  3</span> <span style="color: #008000;">*Email        1210603696@qq.com
</span><span style="color: #008080;">  4</span> <span style="color: #008000;">*File Name    parse.h
</span><span style="color: #008080;">  5</span> <span style="color: #008000;">*Date         2013/10/05
</span><span style="color: #008080;">  6</span> <span style="color: #008000;">*/</span>
<span style="color: #008080;">  7</span> #include <span style="color: #800000;">"</span><span style="color: #800000;">parse.h</span><span style="color: #800000;">"</span>
<span style="color: #008080;">  8</span> 
<span style="color: #008080;">  9</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;"> 10</span> <span style="color: #008000;"> *函数作用：打印tyhp_http_header_t里的header
</span><span style="color: #008080;"> 11</span> <span style="color: #008000;"> *函数参数：tyhp_header 的const 引用
</span><span style="color: #008080;"> 12</span> <span style="color: #008000;"> *函数返回值: 无
</span><span style="color: #008080;"> 13</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 14</span>  <span style="color: #0000ff;">void</span> tyhp_print_http_header_header(<span style="color: #0000ff;">const</span> tyhp_header&amp;<span style="color: #000000;"> head)
</span><span style="color: #008080;"> 15</span> <span style="color: #000000;"> {
</span><span style="color: #008080;"> 16</span>      <span style="color: #0000ff;">if</span>(!<span style="color: #000000;">head.empty())
</span><span style="color: #008080;"> 17</span> <span style="color: #000000;">     {
</span><span style="color: #008080;"> 18</span>          tyhp_header::const_iterator cit =<span style="color: #000000;"> head.begin();
</span><span style="color: #008080;"> 19</span>          <span style="color: #0000ff;">while</span>(cit !=<span style="color: #000000;"> head.end())
</span><span style="color: #008080;"> 20</span> <span style="color: #000000;">         {
</span><span style="color: #008080;"> 21</span>              cout&lt;&lt;cit-&gt;first&lt;&lt;<span style="color: #800000;">"</span><span style="color: #800000;">:</span><span style="color: #800000;">"</span>&lt;&lt;cit-&gt;second&lt;&lt;<span style="color: #000000;">endl;
</span><span style="color: #008080;"> 22</span>              ++<span style="color: #000000;">cit;
</span><span style="color: #008080;"> 23</span> <span style="color: #000000;">         }
</span><span style="color: #008080;"> 24</span> <span style="color: #000000;">     }
</span><span style="color: #008080;"> 25</span> <span style="color: #000000;"> }
</span><span style="color: #008080;"> 26</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;"> 27</span> <span style="color: #008000;"> *函数作用：打印tyhp_http_header_t
</span><span style="color: #008080;"> 28</span> <span style="color: #008000;"> *函数参数：tyhp_http_header_t指针
</span><span style="color: #008080;"> 29</span> <span style="color: #008000;"> *函数返回值: 无
</span><span style="color: #008080;"> 30</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 31</span>  <span style="color: #0000ff;">void</span> tyhp_print_http_header(tyhp_http_header_t *<span style="color: #000000;">phttphdr)
</span><span style="color: #008080;"> 32</span> <span style="color: #000000;"> {
</span><span style="color: #008080;"> 33</span>      <span style="color: #0000ff;">if</span>(NULL ==<span style="color: #000000;"> phttphdr)
</span><span style="color: #008080;"> 34</span> <span style="color: #000000;">     {
</span><span style="color: #008080;"> 35</span>          perror(<span style="color: #800000;">"</span><span style="color: #800000;">phttphdr == NULL</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 36</span>          <span style="color: #0000ff;">return</span><span style="color: #000000;"> ;
</span><span style="color: #008080;"> 37</span> <span style="color: #000000;">     }
</span><span style="color: #008080;"> 38</span> 
<span style="color: #008080;"> 39</span>      cout&lt;&lt;phttphdr-&gt;method&lt;&lt;<span style="color: #800000;">"</span> <span style="color: #800000;">"</span>&lt;&lt;phttphdr-&gt;url&lt;&lt;<span style="color: #800000;">"</span> <span style="color: #800000;">"</span>&lt;&lt;phttphdr-&gt;version&lt;&lt;<span style="color: #000000;">endl;
</span><span style="color: #008080;"> 40</span>     tyhp_print_http_header_header(phttphdr-&gt;<span style="color: #000000;">header);
</span><span style="color: #008080;"> 41</span>     cout&lt;&lt;endl&lt;&lt;phttphdr-&gt;body&lt;&lt;<span style="color: #000000;">endl;
</span><span style="color: #008080;"> 42</span> <span style="color: #000000;"> }
</span><span style="color: #008080;"> 43</span> 
<span style="color: #008080;"> 44</span> 
<span style="color: #008080;"> 45</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;"> 46</span> <span style="color: #008000;"> *函数作用：分配内存给tyhp_http_header_t
</span><span style="color: #008080;"> 47</span> <span style="color: #008000;"> *函数参数：无
</span><span style="color: #008080;"> 48</span> <span style="color: #008000;"> *函数返回值: NULL表示分配失败，其他值表示成功
</span><span style="color: #008080;"> 49</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 50</span> tyhp_http_header_t *<span style="color: #000000;">tyhp_alloc_http_header()
</span><span style="color: #008080;"> 51</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 52</span>     tyhp_http_header_t *phttphdr = (tyhp_http_header_t *)<span style="color: #0000ff;">new</span><span style="color: #000000;"> tyhp_http_header_t;
</span><span style="color: #008080;"> 53</span>     <span style="color: #0000ff;">if</span>(phttphdr ==<span style="color: #000000;"> NULL)
</span><span style="color: #008080;"> 54</span> <span style="color: #000000;">    {
</span><span style="color: #008080;"> 55</span>         perror(<span style="color: #800000;">"</span><span style="color: #800000;">tyhp_alloc_http_header</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 56</span>         exit(-<span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 57</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 58</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> phttphdr;
</span><span style="color: #008080;"> 59</span> <span style="color: #000000;">}
</span><span style="color: #008080;"> 60</span> 
<span style="color: #008080;"> 61</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;"> 62</span> <span style="color: #008000;"> *函数作用：回收分配给tyhp_http_header_t的内存
</span><span style="color: #008080;"> 63</span> <span style="color: #008000;"> *函数参数：tyhp_http_header_t指针
</span><span style="color: #008080;"> 64</span> <span style="color: #008000;"> *函数返回值: 无
</span><span style="color: #008080;"> 65</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 66</span> <span style="color: #0000ff;">void</span> tyhp_free_http_header(tyhp_http_header_t *<span style="color: #000000;">phttphdr)
</span><span style="color: #008080;"> 67</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 68</span>     <span style="color: #0000ff;">if</span>(phttphdr ==<span style="color: #000000;"> NULL)
</span><span style="color: #008080;"> 69</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> ;
</span><span style="color: #008080;"> 70</span> <span style="color: #000000;">    delete phttphdr;
</span><span style="color: #008080;"> 71</span> <span style="color: #000000;">}
</span><span style="color: #008080;"> 72</span> 
<span style="color: #008080;"> 73</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;"> 74</span> <span style="color: #008000;"> *函数作用：解析http_request
</span><span style="color: #008080;"> 75</span> <span style="color: #008000;"> *函数参数：http_request为待解析的值，phttphdr保存了解析下来的值
</span><span style="color: #008080;"> 76</span> <span style="color: #008000;"> *函数返回值: true表示解析成功，false表示解析失败
</span><span style="color: #008080;"> 77</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 78</span> <span style="color: #0000ff;">bool</span> tyhp_parse_http_request(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">string</span>&amp; http_request, tyhp_http_header_t *<span style="color: #000000;">phttphdr)
</span><span style="color: #008080;"> 79</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 80</span>     <span style="color: #0000ff;">if</span><span style="color: #000000;">(http_request.empty())
</span><span style="color: #008080;"> 81</span> <span style="color: #000000;">    {
</span><span style="color: #008080;"> 82</span>         perror(<span style="color: #800000;">"</span><span style="color: #800000;">tyhp_parse_http_request: http_request is empty</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 83</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 84</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 85</span>     <span style="color: #0000ff;">if</span>(phttphdr ==<span style="color: #000000;"> NULL)
</span><span style="color: #008080;"> 86</span> <span style="color: #000000;">    {
</span><span style="color: #008080;"> 87</span>         perror(<span style="color: #800000;">"</span><span style="color: #800000;">tyhp_parse_http_request: phttphdr is NULL</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 88</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 89</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 90</span> 
<span style="color: #008080;"> 91</span>     <span style="color: #0000ff;">string</span> crlf(<span style="color: #800000;">"</span><span style="color: #800000;">\r\n</span><span style="color: #800000;">"</span>), crlfcrlf(<span style="color: #800000;">"</span><span style="color: #800000;">\r\n\r\n</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 92</span>     <span style="color: #0000ff;">int</span> prev = <span style="color: #800080;">0</span>, next = <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 93</span> 
<span style="color: #008080;"> 94</span>     <span style="color: #008000;">//</span><span style="color: #008000;">解析http请求包的起始行</span>
<span style="color: #008080;"> 95</span>     <span style="color: #0000ff;">if</span>((next = http_request.find(crlf, prev)) != <span style="color: #0000ff;">string</span><span style="color: #000000;">::npos)
</span><span style="color: #008080;"> 96</span> <span style="color: #000000;">    {
</span><span style="color: #008080;"> 97</span>         <span style="color: #0000ff;">string</span> first_line(http_request.substr(prev, next -<span style="color: #000000;"> prev));
</span><span style="color: #008080;"> 98</span>         prev =<span style="color: #000000;"> next;
</span><span style="color: #008080;"> 99</span> <span style="color: #000000;">        stringstream sstream(first_line);
</span><span style="color: #008080;">100</span>         sstream &gt;&gt; (phttphdr-&gt;<span style="color: #000000;">method);
</span><span style="color: #008080;">101</span>         sstream &gt;&gt; (phttphdr-&gt;<span style="color: #000000;">url);
</span><span style="color: #008080;">102</span>         sstream &gt;&gt; (phttphdr-&gt;<span style="color: #000000;">version);
</span><span style="color: #008080;">103</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">104</span>     <span style="color: #0000ff;">else</span>
<span style="color: #008080;">105</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">106</span>         perror(<span style="color: #800000;">"</span><span style="color: #800000;">tyhp_parse_http_request: http_request has not a \\r\\n</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">107</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">;
</span><span style="color: #008080;">108</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">109</span> 
<span style="color: #008080;">110</span>     <span style="color: #008000;">//</span><span style="color: #008000;">查找"\r\n\r\n"的位置</span>
<span style="color: #008080;">111</span>     <span style="color: #0000ff;">int</span> pos_crlfcrlf =<span style="color: #000000;"> http_request.find(crlfcrlf, prev);
</span><span style="color: #008080;">112</span>     <span style="color: #0000ff;">if</span>(pos_crlfcrlf == <span style="color: #0000ff;">string</span><span style="color: #000000;">::npos)
</span><span style="color: #008080;">113</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">114</span>         perror(<span style="color: #800000;">"</span><span style="color: #800000;">tyhp_parse_http_request: http_request has not a \"\r\n\r\n\"</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">115</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">;
</span><span style="color: #008080;">116</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">117</span> 
<span style="color: #008080;">118</span>     <span style="color: #008000;">//</span><span style="color: #008000;">解析首部行</span>
<span style="color: #008080;">119</span>     <span style="color: #0000ff;">string</span><span style="color: #000000;"> buff, key, value;
</span><span style="color: #008080;">120</span>     <span style="color: #0000ff;">while</span>(<span style="color: #800080;">1</span><span style="color: #000000;">)
</span><span style="color: #008080;">121</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">122</span>         next = http_request.find(crlf, prev+<span style="color: #800080;">2</span><span style="color: #000000;">);
</span><span style="color: #008080;">123</span>         
<span style="color: #008080;">124</span>         <span style="color: #008000;">//</span><span style="color: #008000;">如果找到的next不超过"\r\n\r\n"的位置</span>
<span style="color: #008080;">125</span>         <span style="color: #0000ff;">if</span>(next &lt;=<span style="color: #000000;"> pos_crlfcrlf)
</span><span style="color: #008080;">126</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">127</span>             <span style="color: #008000;">//</span><span style="color: #008000;">buff保存了一行</span>
<span style="color: #008080;">128</span>             buff = http_request.substr(prev + <span style="color: #800080;">2</span>, next - prev - <span style="color: #800080;">2</span><span style="color: #000000;">);
</span><span style="color: #008080;">129</span>             <span style="color: #0000ff;">int</span> end = <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">130</span>             <span style="color: #008000;">//</span><span style="color: #008000;">跳过前置空白符，到达首部关键字的起始位置</span>
<span style="color: #008080;">131</span>             <span style="color: #0000ff;">for</span>(; isblank(buff[end]); ++<span style="color: #000000;">end)
</span><span style="color: #008080;">132</span> <span style="color: #000000;">                ;
</span><span style="color: #008080;">133</span>             <span style="color: #0000ff;">int</span> beg =<span style="color: #000000;"> end;
</span><span style="color: #008080;">134</span>             <span style="color: #008000;">//</span><span style="color: #008000;">到达首部关键字的结束位置</span>
<span style="color: #008080;">135</span>             <span style="color: #0000ff;">for</span>(; buff[end] != <span style="color: #800000;">'</span><span style="color: #800000;">:</span><span style="color: #800000;">'</span> &amp;&amp; !isblank(buff[end]); ++<span style="color: #000000;">end)
</span><span style="color: #008080;">136</span> <span style="color: #000000;">                ;
</span><span style="color: #008080;">137</span>             key = buff.substr(beg, end -<span style="color: #000000;"> beg);
</span><span style="color: #008080;">138</span>             <span style="color: #008000;">//</span><span style="color: #008000;">跳至首部值的起始位置</span>
<span style="color: #008080;">139</span>             <span style="color: #0000ff;">for</span>(; (!isalpha(buff[end]) &amp;&amp; !isdigit(buff[end])); ++<span style="color: #000000;">end)
</span><span style="color: #008080;">140</span> <span style="color: #000000;">                ;
</span><span style="color: #008080;">141</span>             beg =<span style="color: #000000;"> end;
</span><span style="color: #008080;">142</span>             <span style="color: #008000;">//</span><span style="color: #008000;">到达首部值的结束位置</span>
<span style="color: #008080;">143</span>             <span style="color: #0000ff;">for</span>(; next != end; ++<span style="color: #000000;">end)
</span><span style="color: #008080;">144</span> <span style="color: #000000;">                ;
</span><span style="color: #008080;">145</span>             value = buff.substr(beg, end -<span style="color: #000000;"> beg);
</span><span style="color: #008080;">146</span>             phttphdr-&gt;<span style="color: #000000;">header.insert(make_tyhp_header(key, value));
</span><span style="color: #008080;">147</span> 
<span style="color: #008080;">148</span>             prev =<span style="color: #000000;"> next;
</span><span style="color: #008080;">149</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">150</span>         <span style="color: #0000ff;">else</span>
<span style="color: #008080;">151</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">152</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;">153</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">154</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">155</span> 
<span style="color: #008080;">156</span>     <span style="color: #008000;">//</span><span style="color: #008000;">获取http请求包的实体值（一般情况下不存在）</span>
<span style="color: #008080;">157</span>     phttphdr-&gt;body = http_request.substr(pos_crlfcrlf + <span style="color: #800080;">4</span>, http_request.size() - pos_crlfcrlf - <span style="color: #800080;">4</span><span style="color: #000000;">);
</span><span style="color: #008080;">158</span> 
<span style="color: #008080;">159</span>     <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;
</span><span style="color: #008080;">160</span> <span style="color: #000000;">}
</span><span style="color: #008080;">161</span> 
<span style="color: #008080;">162</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">163</span> <span style="color: #008000;"> *函数作用：根据key的值在phttphdr所指向的tyhp_http_header_t中查找相对应的值
</span><span style="color: #008080;">164</span> <span style="color: #008000;"> *函数参数：key为关键字，header
</span><span style="color: #008080;">165</span> <span style="color: #008000;"> *函数返回值: -返回空值表示查找失败，否则返回相应的值
</span><span style="color: #008080;">166</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">167</span> <span style="color: #0000ff;">string</span> tyhp_get_value_from_http_header(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">string</span>&amp; key, <span style="color: #0000ff;">const</span> tyhp_header&amp;<span style="color: #000000;"> header)
</span><span style="color: #008080;">168</span> <span style="color: #000000;">{
</span><span style="color: #008080;">169</span>     <span style="color: #0000ff;">if</span><span style="color: #000000;">(header.empty())
</span><span style="color: #008080;">170</span>         <span style="color: #0000ff;">return</span> <span style="color: #800000;">""</span><span style="color: #000000;">;
</span><span style="color: #008080;">171</span>     tyhp_header::const_iterator cit =<span style="color: #000000;"> header.find(key);
</span><span style="color: #008080;">172</span>     <span style="color: #0000ff;">if</span>(cit ==<span style="color: #000000;"> header.end())
</span><span style="color: #008080;">173</span>         <span style="color: #0000ff;">return</span> <span style="color: #800000;">""</span><span style="color: #000000;">;
</span><span style="color: #008080;">174</span>     <span style="color: #0000ff;">return</span> (*<span style="color: #000000;">cit).second;
</span><span style="color: #008080;">175</span> }</pre>
</div>
<div class="cnblogs_code">
<pre><span style="color: #008080;">  1</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">  2</span> <span style="color: #008000;">*Author        Zou Xiao hang
</span><span style="color: #008080;">  3</span> <span style="color: #008000;">*Email        1210603696@qq.com
</span><span style="color: #008080;">  4</span> <span style="color: #008000;">*File Name    utility.h
</span><span style="color: #008080;">  5</span> <span style="color: #008000;">*Date         2013/10/05
</span><span style="color: #008080;">  6</span> <span style="color: #008000;">*/</span>
<span style="color: #008080;">  7</span> <span style="color: #000000;">#ifndef _UTILITY_H_
</span><span style="color: #008080;">  8</span> <span style="color: #0000ff;">#define</span> _UTILITY_H_
<span style="color: #008080;">  9</span> 
<span style="color: #008080;"> 10</span> #include &lt;sys/socket.h&gt;
<span style="color: #008080;"> 11</span> #include &lt;sys/types.h&gt;
<span style="color: #008080;"> 12</span> #include &lt;stdlib.h&gt;
<span style="color: #008080;"> 13</span> #include &lt;stdio.h&gt;
<span style="color: #008080;"> 14</span> #include &lt;netdb.h&gt;
<span style="color: #008080;"> 15</span> #include &lt;sys/epoll.h&gt;
<span style="color: #008080;"> 16</span> #include &lt;strings.h&gt;
<span style="color: #008080;"> 17</span> #include &lt;<span style="color: #0000ff;">string</span>&gt;
<span style="color: #008080;"> 18</span> #include &lt;errno.h&gt;
<span style="color: #008080;"> 19</span> #include &lt;unistd.h&gt;
<span style="color: #008080;"> 20</span> #include &lt;fcntl.h&gt;
<span style="color: #008080;"> 21</span> #include &lt;utility&gt;
<span style="color: #008080;"> 22</span> #include &lt;fstream&gt;
<span style="color: #008080;"> 23</span> #include &lt;sstream&gt;
<span style="color: #008080;"> 24</span> #include &lt;map&gt;
<span style="color: #008080;"> 25</span> #include &lt;iostream&gt;
<span style="color: #008080;"> 26</span> #include &lt;<span style="color: #0000ff;">string</span>.h&gt;
<span style="color: #008080;"> 27</span> #include &lt;pthread.h&gt;
<span style="color: #008080;"> 28</span> #include &lt;netinet/tcp.h&gt;
<span style="color: #008080;"> 29</span> #include &lt;time.h&gt;
<span style="color: #008080;"> 30</span> #include &lt;sys/stat.h&gt;
<span style="color: #008080;"> 31</span> 
<span style="color: #008080;"> 32</span> <span style="color: #0000ff;">using</span> <span style="color: #0000ff;">namespace</span><span style="color: #000000;"> std;
</span><span style="color: #008080;"> 33</span> 
<span style="color: #008080;"> 34</span> <span style="color: #0000ff;">extern</span> <span style="color: #0000ff;">string</span><span style="color: #000000;"> tyhp_docroot;
</span><span style="color: #008080;"> 35</span> <span style="color: #0000ff;">#define</span> TYHP_DOCROOT    1
<span style="color: #008080;"> 36</span> <span style="color: #0000ff;">extern</span> <span style="color: #0000ff;">string</span><span style="color: #000000;"> tyhp_domain;
</span><span style="color: #008080;"> 37</span> <span style="color: #0000ff;">#define</span> TYHP_DOMAIN     2
<span style="color: #008080;"> 38</span> 
<span style="color: #008080;"> 39</span> <span style="color: #008000;">/*</span><span style="color: #008000;">**********************************  项目实用工具函数  ******************************************</span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 40</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;"> 41</span> <span style="color: #008000;"> *函数作用：得到系统时间
</span><span style="color: #008080;"> 42</span> <span style="color: #008000;"> *函数参数：无
</span><span style="color: #008080;"> 43</span> <span style="color: #008000;"> *函数返回值: 系统时间 例如：Fri, 22 May 2009 06:07:21 GMT
</span><span style="color: #008080;"> 44</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 45</span> <span style="color: #0000ff;">string</span><span style="color: #000000;"> tyhp_time_gmt();
</span><span style="color: #008080;"> 46</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;"> 47</span> <span style="color: #008000;"> *函数作用：根据http请求包中的url和配置文件中的docroot配置选项构造真正的url
</span><span style="color: #008080;"> 48</span> <span style="color: #008000;"> *函数参数：url
</span><span style="color: #008080;"> 49</span> <span style="color: #008000;"> *函数返回值: 真正的url(绝对路径)
</span><span style="color: #008080;"> 50</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 51</span> <span style="color: #0000ff;">string</span> tyhp_make_real_url(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">string</span>&amp;<span style="color: #000000;"> url);
</span><span style="color: #008080;"> 52</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;"> 53</span> <span style="color: #008000;"> *函数作用：测试文件是否存在
</span><span style="color: #008080;"> 54</span> <span style="color: #008000;"> *函数参数：path为绝对路径+文件名
</span><span style="color: #008080;"> 55</span> <span style="color: #008000;"> *函数返回值: -1表示文件不存在，其他值表示文件存在
</span><span style="color: #008080;"> 56</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 57</span> inline <span style="color: #0000ff;">int</span> tyhp_is_file_existed(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *<span style="color: #000000;">path)
</span><span style="color: #008080;"> 58</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 59</span>     <span style="color: #0000ff;">int</span> ret = open(path, O_RDONLY |<span style="color: #000000;"> O_EXCL);
</span><span style="color: #008080;"> 60</span> <span style="color: #000000;">    close(ret);
</span><span style="color: #008080;"> 61</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> ret;
</span><span style="color: #008080;"> 62</span> <span style="color: #000000;">}
</span><span style="color: #008080;"> 63</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;"> 64</span> <span style="color: #008000;"> *函数作用：获得文件长度
</span><span style="color: #008080;"> 65</span> <span style="color: #008000;"> *函数参数：path为绝对路径+文件名
</span><span style="color: #008080;"> 66</span> <span style="color: #008000;"> *函数返回值: 文件长度
</span><span style="color: #008080;"> 67</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 68</span> <span style="color: #0000ff;">int</span> tyhp_get_file_length(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *<span style="color: #000000;">path);
</span><span style="color: #008080;"> 69</span>  <span style="color: #008000;">/*</span>
<span style="color: #008080;"> 70</span> <span style="color: #008000;"> *函数作用：获得文件最后修改时间
</span><span style="color: #008080;"> 71</span> <span style="color: #008000;"> *函数参数：path为绝对路径+文件名
</span><span style="color: #008080;"> 72</span> <span style="color: #008000;"> *函数返回值: 文件最后修改时间
</span><span style="color: #008080;"> 73</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 74</span>  <span style="color: #0000ff;">string</span> tyhp_get_file_modified_time(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *<span style="color: #000000;">path);
</span><span style="color: #008080;"> 75</span>  <span style="color: #008000;">/*</span>
<span style="color: #008080;"> 76</span> <span style="color: #008000;"> *函数作用：初始化全局变量tyhp_config_keyword_map，必须在使用tyhp_config_keyword_map前调用此函数
</span><span style="color: #008080;"> 77</span> <span style="color: #008000;"> *函数参数：无
</span><span style="color: #008080;"> 78</span> <span style="color: #008000;"> *函数返回值: 无
</span><span style="color: #008080;"> 79</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 80</span>  <span style="color: #0000ff;">void</span><span style="color: #000000;"> tyhp_init_config_keyword_map();
</span><span style="color: #008080;"> 81</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;"> 82</span> <span style="color: #008000;"> *函数作用：解析配置文件
</span><span style="color: #008080;"> 83</span> <span style="color: #008000;"> *函数参数：path为绝对路径+文件名
</span><span style="color: #008080;"> 84</span> <span style="color: #008000;"> *函数返回值: -1表示解析失败，0代表解析成功
</span><span style="color: #008080;"> 85</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 86</span>  <span style="color: #0000ff;">int</span> tyhp_parse_config(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *<span style="color: #000000;">path);
</span><span style="color: #008080;"> 87</span>  <span style="color: #008000;">/*</span>
<span style="color: #008080;"> 88</span> <span style="color: #008000;"> *函数作用：设置文件描述符为非阻塞模式
</span><span style="color: #008080;"> 89</span> <span style="color: #008000;"> *函数参数：要设置的描述符
</span><span style="color: #008080;"> 90</span> <span style="color: #008000;"> *函数返回值: 无
</span><span style="color: #008080;"> 91</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 92</span>  <span style="color: #0000ff;">void</span> tyhp_set_nonblocking(<span style="color: #0000ff;">int</span><span style="color: #000000;"> fd);
</span><span style="color: #008080;"> 93</span>  <span style="color: #008000;">/*</span>
<span style="color: #008080;"> 94</span> <span style="color: #008000;"> *函数作用：设置套接字SO_REUSEADDR选项
</span><span style="color: #008080;"> 95</span> <span style="color: #008000;"> *函数参数：要设置的套接字
</span><span style="color: #008080;"> 96</span> <span style="color: #008000;"> *函数返回值: 无
</span><span style="color: #008080;"> 97</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 98</span>  <span style="color: #0000ff;">void</span> tyhp_set_reuse_addr(<span style="color: #0000ff;">int</span><span style="color: #000000;"> sockfd);
</span><span style="color: #008080;"> 99</span>  <span style="color: #008000;">/*</span>
<span style="color: #008080;">100</span> <span style="color: #008000;"> *函数作用：开启套接字TCP_NODELAY选项，关闭nagle算法
</span><span style="color: #008080;">101</span> <span style="color: #008000;"> *函数参数：要设置的套接字
</span><span style="color: #008080;">102</span> <span style="color: #008000;"> *函数返回值: 无
</span><span style="color: #008080;">103</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">104</span>  <span style="color: #0000ff;">void</span> tyhp_set_off_tcp_nagle(<span style="color: #0000ff;">int</span><span style="color: #000000;"> sockfd);
</span><span style="color: #008080;">105</span>  <span style="color: #008000;">/*</span>
<span style="color: #008080;">106</span> <span style="color: #008000;"> *函数作用：关闭套接字TCP_NODELAY选项，开启nagle算法
</span><span style="color: #008080;">107</span> <span style="color: #008000;"> *函数参数：要设置的套接字
</span><span style="color: #008080;">108</span> <span style="color: #008000;"> *函数返回值: 无
</span><span style="color: #008080;">109</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">110</span>  <span style="color: #0000ff;">void</span> tyhp_set_on_tcp_nagle(<span style="color: #0000ff;">int</span><span style="color: #000000;"> sockfd);
</span><span style="color: #008080;">111</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">112</span> <span style="color: #008000;"> *函数作用：开启套接字TCP_CORK选项
</span><span style="color: #008080;">113</span> <span style="color: #008000;"> *函数参数：要设置的套接字
</span><span style="color: #008080;">114</span> <span style="color: #008000;"> *函数返回值: 无
</span><span style="color: #008080;">115</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">116</span>  <span style="color: #0000ff;">void</span> tyhp_set_on_tcp_cork(<span style="color: #0000ff;">int</span><span style="color: #000000;"> sockfd);
</span><span style="color: #008080;">117</span>  <span style="color: #008000;">/*</span>
<span style="color: #008080;">118</span> <span style="color: #008000;"> *函数作用：关闭套接字TCP_CORK选项
</span><span style="color: #008080;">119</span> <span style="color: #008000;"> *函数参数：要设置的套接字
</span><span style="color: #008080;">120</span> <span style="color: #008000;"> *函数返回值: 无
</span><span style="color: #008080;">121</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">122</span>  <span style="color: #0000ff;">void</span> tyhp_set_off_tcp_cork(<span style="color: #0000ff;">int</span><span style="color: #000000;"> sockfd);
</span><span style="color: #008080;">123</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">124</span> <span style="color: #008000;"> *函数作用：设置套接字SO_RCVTIMEO选项，接收超时
</span><span style="color: #008080;">125</span> <span style="color: #008000;"> *函数参数：sockfd要设置的套接字, sec秒, usec毫秒
</span><span style="color: #008080;">126</span> <span style="color: #008000;"> *函数返回值: 无
</span><span style="color: #008080;">127</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">128</span>  <span style="color: #0000ff;">void</span> tyhp_set_recv_timeo(<span style="color: #0000ff;">int</span> sockfd, <span style="color: #0000ff;">int</span> sec, <span style="color: #0000ff;">int</span><span style="color: #000000;"> usec);
</span><span style="color: #008080;">129</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">130</span> <span style="color: #008000;"> *函数作用：设置套接字SO_SNDTIMEO选项，发送超时
</span><span style="color: #008080;">131</span> <span style="color: #008000;"> *函数参数：sockfd要设置的套接字, sec秒, usec毫秒
</span><span style="color: #008080;">132</span> <span style="color: #008000;"> *函数返回值: 无
</span><span style="color: #008080;">133</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">134</span>  <span style="color: #0000ff;">void</span> tyhp_set_snd_timeo(<span style="color: #0000ff;">int</span> sockfd, <span style="color: #0000ff;">int</span> sec, <span style="color: #0000ff;">int</span><span style="color: #000000;"> usec);
</span><span style="color: #008080;">135</span> <span style="color: #008000;">/*</span><span style="color: #008000;">****************************************************************************************</span><span style="color: #008000;">*/</span>
<span style="color: #008080;">136</span> 
<span style="color: #008080;">137</span> <span style="color: #008000;">/*</span><span style="color: #008000;">**********************************  系统函数的包裹函数  ******************************************</span><span style="color: #008000;">*/</span>
<span style="color: #008080;">138</span> <span style="color: #0000ff;">int</span> tyhp_socket(<span style="color: #0000ff;">int</span> domain, <span style="color: #0000ff;">int</span> type, <span style="color: #0000ff;">int</span><span style="color: #000000;"> protocol);
</span><span style="color: #008080;">139</span> <span style="color: #0000ff;">void</span> tyhp_listen(<span style="color: #0000ff;">int</span> sockfd, <span style="color: #0000ff;">int</span><span style="color: #000000;"> backlog);
</span><span style="color: #008080;">140</span> <span style="color: #0000ff;">void</span> tyhp_bind(<span style="color: #0000ff;">int</span> sockfd, <span style="color: #0000ff;">const</span> <span style="color: #0000ff;">struct</span> sockaddr *<span style="color: #000000;">addr, socklen_t addrlen);
</span><span style="color: #008080;">141</span> <span style="color: #0000ff;">int</span> tyhp_accept(<span style="color: #0000ff;">int</span> sockfd, <span style="color: #0000ff;">struct</span> sockaddr *addr, socklen_t *<span style="color: #000000;">addrlen);
</span><span style="color: #008080;">142</span> <span style="color: #0000ff;">struct</span> servent* tyhp_getservbyname(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *name, <span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *<span style="color: #000000;">proto);
</span><span style="color: #008080;">143</span> <span style="color: #0000ff;">int</span> tyhp_epoll_create(<span style="color: #0000ff;">int</span><span style="color: #000000;"> size);
</span><span style="color: #008080;">144</span> <span style="color: #0000ff;">void</span> tyhp_epoll_ctl(<span style="color: #0000ff;">int</span> epfd, <span style="color: #0000ff;">int</span> op, <span style="color: #0000ff;">int</span> fd, <span style="color: #0000ff;">struct</span> epoll_event *<span style="color: #0000ff;">event</span><span style="color: #000000;">);
</span><span style="color: #008080;">145</span> <span style="color: #0000ff;">int</span> tyhp_epoll_wait(<span style="color: #0000ff;">int</span> epfd, <span style="color: #0000ff;">struct</span> epoll_event *events, <span style="color: #0000ff;">int</span> maxevents, <span style="color: #0000ff;">int</span><span style="color: #000000;"> timeout);
</span><span style="color: #008080;">146</span> 
<span style="color: #008080;">147</span> <span style="color: #0000ff;">void</span> *<span style="color: #000000;">tyhp_calloc(size_t nmemb, size_t size);
</span><span style="color: #008080;">148</span> <span style="color: #0000ff;">void</span> *<span style="color: #000000;">tyhp_malloc(size_t size);
</span><span style="color: #008080;">149</span> <span style="color: #0000ff;">void</span> tyhp_free(<span style="color: #0000ff;">void</span> *<span style="color: #000000;">ptr);
</span><span style="color: #008080;">150</span> <span style="color: #008000;">/*</span><span style="color: #008000;">****************************************************************************************</span><span style="color: #008000;">*/</span>
<span style="color: #008080;">151</span> <span style="color: #0000ff;">#endif</span></pre>
</div>
<div class="cnblogs_code">
<pre><span style="color: #008080;">  1</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">  2</span> <span style="color: #008000;">*Author        Zou Xiao hang
</span><span style="color: #008080;">  3</span> <span style="color: #008000;">*Email        1210603696@qq.com
</span><span style="color: #008080;">  4</span> <span style="color: #008000;">*File Name    utility.cpp
</span><span style="color: #008080;">  5</span> <span style="color: #008000;">*Date         2013/10/05
</span><span style="color: #008080;">  6</span> <span style="color: #008000;">*/</span>
<span style="color: #008080;">  7</span> #include <span style="color: #800000;">"</span><span style="color: #800000;">utility.h</span><span style="color: #800000;">"</span>
<span style="color: #008080;">  8</span> 
<span style="color: #008080;">  9</span> <span style="color: #008000;">//</span><span style="color: #008000;">存储解析文件的键值对，例如key=docroot value=/home/zxh/desktop/code/webserver</span>
<span style="color: #008080;"> 10</span> map&lt;<span style="color: #0000ff;">string</span>, <span style="color: #0000ff;">int</span>&gt;<span style="color: #000000;"> tyhp_config_keyword_map;
</span><span style="color: #008080;"> 11</span> 
<span style="color: #008080;"> 12</span> <span style="color: #008000;">/*</span><span style="color: #008000;">**********************************  项目实用工具函数  ******************************************</span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 13</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;"> 14</span> <span style="color: #008000;"> *函数作用：得到系统时间
</span><span style="color: #008080;"> 15</span> <span style="color: #008000;"> *函数参数：无
</span><span style="color: #008080;"> 16</span> <span style="color: #008000;"> *函数返回值: 系统时间 例如：Fri, 22 May 2009 06:07:21 GMT
</span><span style="color: #008080;"> 17</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 18</span> <span style="color: #0000ff;">string</span><span style="color: #000000;"> tyhp_time_gmt()
</span><span style="color: #008080;"> 19</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 20</span> <span style="color: #000000;">    time_t now;
</span><span style="color: #008080;"> 21</span>     <span style="color: #0000ff;">struct</span> tm *<span style="color: #000000;">time_now;
</span><span style="color: #008080;"> 22</span>     <span style="color: #0000ff;">string</span><span style="color: #000000;"> str_time;
</span><span style="color: #008080;"> 23</span> 
<span style="color: #008080;"> 24</span>     time(&amp;<span style="color: #000000;">now);
</span><span style="color: #008080;"> 25</span>     time_now = localtime(&amp;<span style="color: #000000;">now);
</span><span style="color: #008080;"> 26</span> 
<span style="color: #008080;"> 27</span>     <span style="color: #0000ff;">switch</span>(time_now-&gt;<span style="color: #000000;">tm_wday)
</span><span style="color: #008080;"> 28</span> <span style="color: #000000;">    {
</span><span style="color: #008080;"> 29</span>         <span style="color: #0000ff;">case</span> <span style="color: #800080;">0</span><span style="color: #000000;">:
</span><span style="color: #008080;"> 30</span>             str_time += <span style="color: #800000;">"</span><span style="color: #800000;">Sun, </span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 31</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 32</span>         <span style="color: #0000ff;">case</span> <span style="color: #800080;">1</span><span style="color: #000000;">:
</span><span style="color: #008080;"> 33</span>             str_time += <span style="color: #800000;">"</span><span style="color: #800000;">Mon, </span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 34</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 35</span>         <span style="color: #0000ff;">case</span> <span style="color: #800080;">2</span><span style="color: #000000;">:
</span><span style="color: #008080;"> 36</span>             str_time += <span style="color: #800000;">"</span><span style="color: #800000;">Tue, </span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 37</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 38</span>         <span style="color: #0000ff;">case</span> <span style="color: #800080;">3</span><span style="color: #000000;">:
</span><span style="color: #008080;"> 39</span>             str_time += <span style="color: #800000;">"</span><span style="color: #800000;">Wed, </span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 40</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 41</span>         <span style="color: #0000ff;">case</span> <span style="color: #800080;">4</span><span style="color: #000000;">:
</span><span style="color: #008080;"> 42</span>             str_time += <span style="color: #800000;">"</span><span style="color: #800000;">Thu, </span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 43</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 44</span>         <span style="color: #0000ff;">case</span> <span style="color: #800080;">5</span><span style="color: #000000;">:
</span><span style="color: #008080;"> 45</span>             str_time += <span style="color: #800000;">"</span><span style="color: #800000;">Fri, </span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 46</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 47</span>         <span style="color: #0000ff;">case</span> <span style="color: #800080;">6</span><span style="color: #000000;">:
</span><span style="color: #008080;"> 48</span>             str_time += <span style="color: #800000;">"</span><span style="color: #800000;">Sat, </span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 49</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 50</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 51</span>     <span style="color: #0000ff;">char</span> buf[<span style="color: #800080;">16</span><span style="color: #000000;">];
</span><span style="color: #008080;"> 52</span>     snprintf(buf, <span style="color: #0000ff;">sizeof</span>(buf), <span style="color: #800000;">"</span><span style="color: #800000;">%d </span><span style="color: #800000;">"</span>, time_now-&gt;<span style="color: #000000;">tm_mday);
</span><span style="color: #008080;"> 53</span>     str_time += <span style="color: #0000ff;">string</span><span style="color: #000000;">(buf);
</span><span style="color: #008080;"> 54</span>     <span style="color: #0000ff;">switch</span>(time_now-&gt;<span style="color: #000000;">tm_mon)
</span><span style="color: #008080;"> 55</span> <span style="color: #000000;">    {
</span><span style="color: #008080;"> 56</span>         <span style="color: #0000ff;">case</span> <span style="color: #800080;">0</span><span style="color: #000000;">:
</span><span style="color: #008080;"> 57</span>             str_time += <span style="color: #800000;">"</span><span style="color: #800000;">Jan </span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 58</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 59</span>         <span style="color: #0000ff;">case</span> <span style="color: #800080;">1</span><span style="color: #000000;">:
</span><span style="color: #008080;"> 60</span>             str_time += <span style="color: #800000;">"</span><span style="color: #800000;">Feb </span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 61</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 62</span>         <span style="color: #0000ff;">case</span> <span style="color: #800080;">2</span><span style="color: #000000;">:
</span><span style="color: #008080;"> 63</span>             str_time += <span style="color: #800000;">"</span><span style="color: #800000;">Mar </span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 64</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 65</span>         <span style="color: #0000ff;">case</span> <span style="color: #800080;">3</span><span style="color: #000000;">:
</span><span style="color: #008080;"> 66</span>             str_time += <span style="color: #800000;">"</span><span style="color: #800000;">Apr </span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 67</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 68</span>         <span style="color: #0000ff;">case</span> <span style="color: #800080;">4</span><span style="color: #000000;">:
</span><span style="color: #008080;"> 69</span>             str_time += <span style="color: #800000;">"</span><span style="color: #800000;">May </span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 70</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 71</span>         <span style="color: #0000ff;">case</span> <span style="color: #800080;">5</span><span style="color: #000000;">:
</span><span style="color: #008080;"> 72</span>             str_time += <span style="color: #800000;">"</span><span style="color: #800000;">Jun </span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 73</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 74</span>         <span style="color: #0000ff;">case</span> <span style="color: #800080;">6</span><span style="color: #000000;">:
</span><span style="color: #008080;"> 75</span>             str_time += <span style="color: #800000;">"</span><span style="color: #800000;">Jul </span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 76</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 77</span>         <span style="color: #0000ff;">case</span> <span style="color: #800080;">7</span><span style="color: #000000;">:
</span><span style="color: #008080;"> 78</span>             str_time += <span style="color: #800000;">"</span><span style="color: #800000;">Aug </span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 79</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 80</span>         <span style="color: #0000ff;">case</span> <span style="color: #800080;">8</span><span style="color: #000000;">:
</span><span style="color: #008080;"> 81</span>             str_time += <span style="color: #800000;">"</span><span style="color: #800000;">Sep </span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 82</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 83</span>         <span style="color: #0000ff;">case</span> <span style="color: #800080;">9</span><span style="color: #000000;">:
</span><span style="color: #008080;"> 84</span>             str_time += <span style="color: #800000;">"</span><span style="color: #800000;">Oct </span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 85</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 86</span>         <span style="color: #0000ff;">case</span> <span style="color: #800080;">10</span><span style="color: #000000;">:
</span><span style="color: #008080;"> 87</span>             str_time += <span style="color: #800000;">"</span><span style="color: #800000;">Nov </span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 88</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 89</span>         <span style="color: #0000ff;">case</span> <span style="color: #800080;">11</span><span style="color: #000000;">:
</span><span style="color: #008080;"> 90</span>             str_time += <span style="color: #800000;">"</span><span style="color: #800000;">Dec </span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 91</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 92</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 93</span>     snprintf(buf, <span style="color: #0000ff;">sizeof</span>(buf), <span style="color: #800000;">"</span><span style="color: #800000;">%d</span><span style="color: #800000;">"</span>, time_now-&gt;tm_year + <span style="color: #800080;">1900</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 94</span>     str_time += <span style="color: #0000ff;">string</span><span style="color: #000000;">(buf);
</span><span style="color: #008080;"> 95</span>     snprintf(buf, <span style="color: #0000ff;">sizeof</span>(buf), <span style="color: #800000;">"</span><span style="color: #800000;"> %d:%d:%d </span><span style="color: #800000;">"</span>, time_now-&gt;tm_hour, time_now-&gt;tm_min, time_now-&gt;<span style="color: #000000;">tm_sec);
</span><span style="color: #008080;"> 96</span>     str_time += <span style="color: #0000ff;">string</span><span style="color: #000000;">(buf);
</span><span style="color: #008080;"> 97</span> 
<span style="color: #008080;"> 98</span>     str_time += <span style="color: #800000;">"</span><span style="color: #800000;">GMT</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 99</span> 
<span style="color: #008080;">100</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> str_time;
</span><span style="color: #008080;">101</span> <span style="color: #000000;">}
</span><span style="color: #008080;">102</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">103</span> <span style="color: #008000;"> *函数作用：根据http请求包中的url和配置文件中的docroot配置选项构造真正的url
</span><span style="color: #008080;">104</span> <span style="color: #008000;"> *函数参数：url
</span><span style="color: #008080;">105</span> <span style="color: #008000;"> *函数返回值: 真正的url(绝对路径)
</span><span style="color: #008080;">106</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">107</span> <span style="color: #0000ff;">string</span> tyhp_make_real_url(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">string</span>&amp;<span style="color: #000000;"> url)
</span><span style="color: #008080;">108</span> <span style="color: #000000;">{
</span><span style="color: #008080;">109</span>     <span style="color: #0000ff;">string</span><span style="color: #000000;"> real_url, url2;
</span><span style="color: #008080;">110</span> 
<span style="color: #008080;">111</span>     <span style="color: #0000ff;">int</span> n = <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">112</span>     
<span style="color: #008080;">113</span>     <span style="color: #0000ff;">if</span>((n = url.find(tyhp_domain, <span style="color: #800080;">0</span>)) != <span style="color: #0000ff;">string</span>::npos)<span style="color: #008000;">//</span><span style="color: #008000;">url中包含域名，要将其删去</span>
<span style="color: #008080;">114</span>         url2 = url.substr(tyhp_domain.size(), url.size() -<span style="color: #000000;"> tyhp_domain.size());
</span><span style="color: #008080;">115</span>     <span style="color: #0000ff;">else</span>
<span style="color: #008080;">116</span>         url2 =<span style="color: #000000;"> url;
</span><span style="color: #008080;">117</span> 
<span style="color: #008080;">118</span>     <span style="color: #0000ff;">if</span>(tyhp_docroot[tyhp_docroot.size() - <span style="color: #800080;">1</span>] == <span style="color: #800000;">'</span><span style="color: #800000;">/</span><span style="color: #800000;">'</span>)<span style="color: #008000;">//</span><span style="color: #008000;">配置项docroot末尾有'/'</span>
<span style="color: #008080;">119</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">120</span>         <span style="color: #0000ff;">if</span>(url2[<span style="color: #800080;">0</span>] == <span style="color: #800000;">'</span><span style="color: #800000;">/</span><span style="color: #800000;">'</span><span style="color: #000000;">)
</span><span style="color: #008080;">121</span>             real_url = tyhp_docroot + url2.erase(<span style="color: #800080;">0</span>, <span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;">122</span>         <span style="color: #0000ff;">else</span>
<span style="color: #008080;">123</span>             real_url = tyhp_docroot +<span style="color: #000000;"> url2;
</span><span style="color: #008080;">124</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">125</span>     <span style="color: #0000ff;">else</span><span style="color: #008000;">//</span><span style="color: #008000;">配置项docroot末尾没有'\'</span>
<span style="color: #008080;">126</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">127</span>         <span style="color: #0000ff;">if</span>(url2[<span style="color: #800080;">0</span>] == <span style="color: #800000;">'</span><span style="color: #800000;">/</span><span style="color: #800000;">'</span><span style="color: #000000;">)
</span><span style="color: #008080;">128</span>             real_url = tyhp_docroot +<span style="color: #000000;"> url2;
</span><span style="color: #008080;">129</span>         <span style="color: #0000ff;">else</span>
<span style="color: #008080;">130</span>             real_url = tyhp_docroot + <span style="color: #800000;">'</span><span style="color: #800000;">/</span><span style="color: #800000;">'</span> +<span style="color: #000000;"> url2;
</span><span style="color: #008080;">131</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">132</span> 
<span style="color: #008080;">133</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> real_url;
</span><span style="color: #008080;">134</span> <span style="color: #000000;">}
</span><span style="color: #008080;">135</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">136</span> <span style="color: #008000;"> *函数作用：获得文件长度
</span><span style="color: #008080;">137</span> <span style="color: #008000;"> *函数参数：path为绝对路径+文件名
</span><span style="color: #008080;">138</span> <span style="color: #008000;"> *函数返回值: 文件长度
</span><span style="color: #008080;">139</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">140</span>  <span style="color: #0000ff;">int</span> tyhp_get_file_length(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *<span style="color: #000000;">path)
</span><span style="color: #008080;">141</span> <span style="color: #000000;"> {
</span><span style="color: #008080;">142</span>      <span style="color: #0000ff;">struct</span><span style="color: #000000;"> stat buf;
</span><span style="color: #008080;">143</span>      <span style="color: #0000ff;">int</span> ret = stat(path, &amp;<span style="color: #000000;">buf);
</span><span style="color: #008080;">144</span>      <span style="color: #0000ff;">if</span>(ret == -<span style="color: #800080;">1</span><span style="color: #000000;">)
</span><span style="color: #008080;">145</span> <span style="color: #000000;">     {
</span><span style="color: #008080;">146</span>          perror(<span style="color: #800000;">"</span><span style="color: #800000;">tyhp_get_file_length</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">147</span>          exit(-<span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;">148</span> <span style="color: #000000;">     }
</span><span style="color: #008080;">149</span>      <span style="color: #0000ff;">return</span> (<span style="color: #0000ff;">int</span><span style="color: #000000;">)buf.st_size;
</span><span style="color: #008080;">150</span> <span style="color: #000000;"> }
</span><span style="color: #008080;">151</span>   <span style="color: #008000;">/*</span>
<span style="color: #008080;">152</span> <span style="color: #008000;"> *函数作用：获得文件最后修改时间
</span><span style="color: #008080;">153</span> <span style="color: #008000;"> *函数参数：path为绝对路径+文件名
</span><span style="color: #008080;">154</span> <span style="color: #008000;"> *函数返回值: 文件最后修改时间
</span><span style="color: #008080;">155</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">156</span>  <span style="color: #0000ff;">string</span> tyhp_get_file_modified_time(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *<span style="color: #000000;">path)
</span><span style="color: #008080;">157</span> <span style="color: #000000;"> {
</span><span style="color: #008080;">158</span>      <span style="color: #0000ff;">struct</span><span style="color: #000000;"> stat buf;
</span><span style="color: #008080;">159</span>      <span style="color: #0000ff;">int</span> ret = stat(path, &amp;<span style="color: #000000;">buf);
</span><span style="color: #008080;">160</span>      <span style="color: #0000ff;">if</span>(ret == -<span style="color: #800080;">1</span><span style="color: #000000;">)
</span><span style="color: #008080;">161</span> <span style="color: #000000;">     {
</span><span style="color: #008080;">162</span>          perror(<span style="color: #800000;">"</span><span style="color: #800000;">tyhp_get_file_length</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">163</span>          exit(-<span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;">164</span> <span style="color: #000000;">     }
</span><span style="color: #008080;">165</span>      <span style="color: #0000ff;">char</span> array[<span style="color: #800080;">32</span>] = {<span style="color: #800080;">0</span><span style="color: #000000;">};
</span><span style="color: #008080;">166</span>      snprintf(array, <span style="color: #0000ff;">sizeof</span>(array), <span style="color: #800000;">"</span><span style="color: #800000;">%s</span><span style="color: #800000;">"</span>, ctime(&amp;<span style="color: #000000;">buf.st_mtime));
</span><span style="color: #008080;">167</span>      <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">string</span>(array, array +<span style="color: #000000;"> strlen(array));
</span><span style="color: #008080;">168</span> <span style="color: #000000;"> }
</span><span style="color: #008080;">169</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">170</span> <span style="color: #008000;"> *函数作用：初始化全局变量tyhp_config_keyword_map，必须在使用tyhp_config_keyword_map前调用此函数
</span><span style="color: #008080;">171</span> <span style="color: #008000;"> *函数参数：无
</span><span style="color: #008080;">172</span> <span style="color: #008000;"> *函数返回值: 无
</span><span style="color: #008080;">173</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">174</span>  <span style="color: #0000ff;">void</span><span style="color: #000000;"> tyhp_init_config_keyword_map()
</span><span style="color: #008080;">175</span> <span style="color: #000000;"> {
</span><span style="color: #008080;">176</span>      tyhp_config_keyword_map.insert(make_pair(<span style="color: #800000;">"</span><span style="color: #800000;">docroot</span><span style="color: #800000;">"</span><span style="color: #000000;">, TYHP_DOCROOT));
</span><span style="color: #008080;">177</span>      tyhp_config_keyword_map.insert(make_pair(<span style="color: #800000;">"</span><span style="color: #800000;">domain</span><span style="color: #800000;">"</span><span style="color: #000000;">, TYHP_DOMAIN));
</span><span style="color: #008080;">178</span> <span style="color: #000000;"> }
</span><span style="color: #008080;">179</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">180</span> <span style="color: #008000;"> *函数作用：解析配置文件
</span><span style="color: #008080;">181</span> <span style="color: #008000;"> *函数参数：path为绝对路径+文件名
</span><span style="color: #008080;">182</span> <span style="color: #008000;"> *函数返回值: -1表示解析失败，0代表解析成功
</span><span style="color: #008080;">183</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">184</span>  <span style="color: #0000ff;">int</span> tyhp_parse_config(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *<span style="color: #000000;">path)
</span><span style="color: #008080;">185</span> <span style="color: #000000;"> {
</span><span style="color: #008080;">186</span> <span style="color: #000000;">     tyhp_init_config_keyword_map();
</span><span style="color: #008080;">187</span>      <span style="color: #0000ff;">int</span> ret = <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">188</span>      fstream infile(path, fstream::<span style="color: #0000ff;">in</span><span style="color: #000000;">);
</span><span style="color: #008080;">189</span>      <span style="color: #0000ff;">string</span><span style="color: #000000;"> line, word;
</span><span style="color: #008080;">190</span>      <span style="color: #0000ff;">if</span>(!<span style="color: #000000;">infile)
</span><span style="color: #008080;">191</span> <span style="color: #000000;">     {
</span><span style="color: #008080;">192</span>          printf(<span style="color: #800000;">"</span><span style="color: #800000;">%s can't open\n</span><span style="color: #800000;">"</span><span style="color: #000000;">, path);
</span><span style="color: #008080;">193</span> <span style="color: #000000;">         infile.close();
</span><span style="color: #008080;">194</span>          <span style="color: #0000ff;">return</span> -<span style="color: #800080;">1</span><span style="color: #000000;">;
</span><span style="color: #008080;">195</span> <span style="color: #000000;">     }
</span><span style="color: #008080;">196</span>      <span style="color: #0000ff;">while</span><span style="color: #000000;">(getline(infile, line))
</span><span style="color: #008080;">197</span> <span style="color: #000000;">     {
</span><span style="color: #008080;">198</span> <span style="color: #000000;">         stringstream stream(line);
</span><span style="color: #008080;">199</span>          stream &gt;&gt; word;<span style="color: #008000;">//</span><span style="color: #008000;">keyword</span>
<span style="color: #008080;">200</span>          map&lt;<span style="color: #0000ff;">string</span>, <span style="color: #0000ff;">int</span>&gt;::const_iterator cit=<span style="color: #000000;"> tyhp_config_keyword_map.find(word);
</span><span style="color: #008080;">201</span>          <span style="color: #0000ff;">if</span>(cit ==<span style="color: #000000;"> tyhp_config_keyword_map.end())
</span><span style="color: #008080;">202</span> <span style="color: #000000;">         {
</span><span style="color: #008080;">203</span>              printf(<span style="color: #800000;">"</span><span style="color: #800000;">can't find keyword\n</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">204</span> <span style="color: #000000;">             infile.close();
</span><span style="color: #008080;">205</span>              <span style="color: #0000ff;">return</span> -<span style="color: #800080;">1</span><span style="color: #000000;">;
</span><span style="color: #008080;">206</span> <span style="color: #000000;">         }
</span><span style="color: #008080;">207</span>          <span style="color: #0000ff;">switch</span> (cit-&gt;<span style="color: #000000;">second)
</span><span style="color: #008080;">208</span> <span style="color: #000000;">         {
</span><span style="color: #008080;">209</span>              <span style="color: #0000ff;">case</span><span style="color: #000000;"> TYHP_DOCROOT:
</span><span style="color: #008080;">210</span>                  stream &gt;&gt;<span style="color: #000000;"> tyhp_docroot;
</span><span style="color: #008080;">211</span>                  <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;">212</span>              <span style="color: #0000ff;">case</span><span style="color: #000000;"> TYHP_DOMAIN:
</span><span style="color: #008080;">213</span>                  stream &gt;&gt;<span style="color: #000000;"> tyhp_domain;
</span><span style="color: #008080;">214</span>                  <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;">215</span>              <span style="color: #0000ff;">default</span><span style="color: #000000;"> :
</span><span style="color: #008080;">216</span> <span style="color: #000000;">                 infile.close();
</span><span style="color: #008080;">217</span>                  <span style="color: #0000ff;">return</span> -<span style="color: #800080;">1</span><span style="color: #000000;">;
</span><span style="color: #008080;">218</span> <span style="color: #000000;">         }
</span><span style="color: #008080;">219</span> <span style="color: #000000;">     }
</span><span style="color: #008080;">220</span> <span style="color: #000000;">     infile.close();
</span><span style="color: #008080;">221</span>      <span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">222</span> <span style="color: #000000;"> }
</span><span style="color: #008080;">223</span>   <span style="color: #008000;">/*</span>
<span style="color: #008080;">224</span> <span style="color: #008000;"> *函数作用：设置文件描述符为非阻塞模式
</span><span style="color: #008080;">225</span> <span style="color: #008000;"> *函数参数：要设置的描述符
</span><span style="color: #008080;">226</span> <span style="color: #008000;"> *函数返回值: 无
</span><span style="color: #008080;">227</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">228</span>  <span style="color: #0000ff;">void</span> tyhp_set_nonblocking(<span style="color: #0000ff;">int</span><span style="color: #000000;"> fd)
</span><span style="color: #008080;">229</span> <span style="color: #000000;"> {
</span><span style="color: #008080;">230</span>     <span style="color: #0000ff;">int</span> flags = fcntl(fd, F_GETFL, <span style="color: #800080;">0</span><span style="color: #000000;">);
</span><span style="color: #008080;">231</span>     <span style="color: #0000ff;">if</span>(flags &lt; <span style="color: #800080;">0</span><span style="color: #000000;">)
</span><span style="color: #008080;">232</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">233</span>         perror(<span style="color: #800000;">"</span><span style="color: #800000;">fcntl: F_GETFL</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">234</span>         exit(-<span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;">235</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">236</span>     flags |=<span style="color: #000000;"> O_NONBLOCK;
</span><span style="color: #008080;">237</span>     <span style="color: #0000ff;">int</span> ret =<span style="color: #000000;"> fcntl(fd, F_SETFL, flags);
</span><span style="color: #008080;">238</span>     <span style="color: #0000ff;">if</span>(ret &lt; <span style="color: #800080;">0</span><span style="color: #000000;">)
</span><span style="color: #008080;">239</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">240</span>         perror(<span style="color: #800000;">"</span><span style="color: #800000;">fcntl</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">241</span>         exit(-<span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;">242</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">243</span> <span style="color: #000000;"> }
</span><span style="color: #008080;">244</span>   <span style="color: #008000;">/*</span>
<span style="color: #008080;">245</span> <span style="color: #008000;"> *函数作用：设置套接字SO_REUSEADDR选项
</span><span style="color: #008080;">246</span> <span style="color: #008000;"> *函数参数：要设置的套接字
</span><span style="color: #008080;">247</span> <span style="color: #008000;"> *函数返回值: 无
</span><span style="color: #008080;">248</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">249</span>  <span style="color: #0000ff;">void</span> tyhp_set_reuse_addr(<span style="color: #0000ff;">int</span><span style="color: #000000;"> sockfd)
</span><span style="color: #008080;">250</span> <span style="color: #000000;">{
</span><span style="color: #008080;">251</span>     <span style="color: #0000ff;">int</span> on = <span style="color: #800080;">1</span><span style="color: #000000;">;
</span><span style="color: #008080;">252</span>     <span style="color: #0000ff;">int</span> ret = setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;on, <span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(on));
</span><span style="color: #008080;">253</span>     <span style="color: #0000ff;">if</span>(ret == -<span style="color: #800080;">1</span><span style="color: #000000;">)
</span><span style="color: #008080;">254</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">255</span>         perror(<span style="color: #800000;">"</span><span style="color: #800000;">setsockopt: SO_REUSEADDR</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">256</span>         exit(-<span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;">257</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">258</span> <span style="color: #000000;">}
</span><span style="color: #008080;">259</span>  <span style="color: #008000;">/*</span>
<span style="color: #008080;">260</span> <span style="color: #008000;"> *函数作用：开启套接字TCP_NODELAY选项，关闭nagle算法
</span><span style="color: #008080;">261</span> <span style="color: #008000;"> *函数参数：要设置的套接字
</span><span style="color: #008080;">262</span> <span style="color: #008000;"> *函数返回值: 无
</span><span style="color: #008080;">263</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">264</span>  <span style="color: #0000ff;">void</span> tyhp_set_off_tcp_nagle(<span style="color: #0000ff;">int</span><span style="color: #000000;"> sockfd)
</span><span style="color: #008080;">265</span> <span style="color: #000000;"> {
</span><span style="color: #008080;">266</span>      <span style="color: #0000ff;">int</span> on = <span style="color: #800080;">1</span><span style="color: #000000;">;
</span><span style="color: #008080;">267</span>      <span style="color: #0000ff;">int</span> ret = setsockopt(sockfd, IPPROTO_TCP, TCP_NODELAY, &amp;on, <span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(on));
</span><span style="color: #008080;">268</span>      <span style="color: #0000ff;">if</span>(ret == -<span style="color: #800080;">1</span><span style="color: #000000;">)
</span><span style="color: #008080;">269</span> <span style="color: #000000;">     {
</span><span style="color: #008080;">270</span>          perror(<span style="color: #800000;">"</span><span style="color: #800000;">setsockopt: TCP_NODELAY ON</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">271</span>         exit(-<span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;">272</span> <span style="color: #000000;">     }
</span><span style="color: #008080;">273</span> <span style="color: #000000;"> }
</span><span style="color: #008080;">274</span>  <span style="color: #008000;">/*</span>
<span style="color: #008080;">275</span> <span style="color: #008000;"> *函数作用：关闭套接字TCP_NODELAY选项，开启nagle算法
</span><span style="color: #008080;">276</span> <span style="color: #008000;"> *函数参数：要设置的套接字
</span><span style="color: #008080;">277</span> <span style="color: #008000;"> *函数返回值: 无
</span><span style="color: #008080;">278</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">279</span>  <span style="color: #0000ff;">void</span> tyhp_set_on_tcp_nagle(<span style="color: #0000ff;">int</span><span style="color: #000000;"> sockfd)
</span><span style="color: #008080;">280</span> <span style="color: #000000;"> {
</span><span style="color: #008080;">281</span>      <span style="color: #0000ff;">int</span> off = <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">282</span>      <span style="color: #0000ff;">int</span> ret = setsockopt(sockfd, IPPROTO_TCP, TCP_NODELAY, &amp;off, <span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(off));
</span><span style="color: #008080;">283</span>      <span style="color: #0000ff;">if</span>(ret == -<span style="color: #800080;">1</span><span style="color: #000000;">)
</span><span style="color: #008080;">284</span> <span style="color: #000000;">     {
</span><span style="color: #008080;">285</span>          perror(<span style="color: #800000;">"</span><span style="color: #800000;">setsockopt: TCP_NODELAY OFF</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">286</span>         exit(-<span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;">287</span> <span style="color: #000000;">     }
</span><span style="color: #008080;">288</span> <span style="color: #000000;"> }
</span><span style="color: #008080;">289</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">290</span> <span style="color: #008000;"> *函数作用：开启套接字TCP_CORK选项
</span><span style="color: #008080;">291</span> <span style="color: #008000;"> *函数参数：要设置的套接字
</span><span style="color: #008080;">292</span> <span style="color: #008000;"> *函数返回值: 无
</span><span style="color: #008080;">293</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">294</span>  <span style="color: #0000ff;">void</span> tyhp_set_on_tcp_cork(<span style="color: #0000ff;">int</span><span style="color: #000000;"> sockfd)
</span><span style="color: #008080;">295</span> <span style="color: #000000;"> {
</span><span style="color: #008080;">296</span>      <span style="color: #0000ff;">int</span> on = <span style="color: #800080;">1</span><span style="color: #000000;">;
</span><span style="color: #008080;">297</span>      <span style="color: #0000ff;">int</span> ret = setsockopt(sockfd, SOL_TCP, TCP_CORK, &amp;on, <span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(on));
</span><span style="color: #008080;">298</span>      <span style="color: #0000ff;">if</span>(ret == -<span style="color: #800080;">1</span><span style="color: #000000;">)
</span><span style="color: #008080;">299</span> <span style="color: #000000;">     {
</span><span style="color: #008080;">300</span>          perror(<span style="color: #800000;">"</span><span style="color: #800000;">setsockopt: TCP_CORK ON</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">301</span>         exit(-<span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;">302</span> <span style="color: #000000;">     }
</span><span style="color: #008080;">303</span> <span style="color: #000000;"> }
</span><span style="color: #008080;">304</span>  <span style="color: #008000;">/*</span>
<span style="color: #008080;">305</span> <span style="color: #008000;"> *函数作用：关闭套接字TCP_CORK选项
</span><span style="color: #008080;">306</span> <span style="color: #008000;"> *函数参数：要设置的套接字
</span><span style="color: #008080;">307</span> <span style="color: #008000;"> *函数返回值: 无
</span><span style="color: #008080;">308</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">309</span>  <span style="color: #0000ff;">void</span> tyhp_set_off_tcp_cork(<span style="color: #0000ff;">int</span><span style="color: #000000;"> sockfd)
</span><span style="color: #008080;">310</span> <span style="color: #000000;"> {
</span><span style="color: #008080;">311</span>      <span style="color: #0000ff;">int</span> off = <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">312</span>      <span style="color: #0000ff;">int</span> ret = setsockopt(sockfd, SOL_TCP, TCP_CORK, &amp;off, <span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(off));
</span><span style="color: #008080;">313</span>      <span style="color: #0000ff;">if</span>(ret == -<span style="color: #800080;">1</span><span style="color: #000000;">)
</span><span style="color: #008080;">314</span> <span style="color: #000000;">     {
</span><span style="color: #008080;">315</span>          perror(<span style="color: #800000;">"</span><span style="color: #800000;">setsockopt: TCP_CORK OFF</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">316</span>         exit(-<span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;">317</span> <span style="color: #000000;">     }
</span><span style="color: #008080;">318</span> <span style="color: #000000;"> }
</span><span style="color: #008080;">319</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">320</span> <span style="color: #008000;"> *函数作用：设置套接字SO_RCVTIMEO选项，接收超时
</span><span style="color: #008080;">321</span> <span style="color: #008000;"> *函数参数：sockfd要设置的套接字, sec秒, usec毫秒
</span><span style="color: #008080;">322</span> <span style="color: #008000;"> *函数返回值: 无
</span><span style="color: #008080;">323</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">324</span>  <span style="color: #0000ff;">void</span> tyhp_set_recv_timeo(<span style="color: #0000ff;">int</span> sockfd, <span style="color: #0000ff;">int</span> sec, <span style="color: #0000ff;">int</span><span style="color: #000000;"> usec)
</span><span style="color: #008080;">325</span> <span style="color: #000000;"> {
</span><span style="color: #008080;">326</span>      <span style="color: #0000ff;">struct</span> timeval time=<span style="color: #000000;"> {sec, usec};
</span><span style="color: #008080;">327</span>      <span style="color: #0000ff;">int</span> ret = setsockopt(sockfd, SOL_SOCKET, SO_RCVTIMEO, &amp;time, <span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(time));
</span><span style="color: #008080;">328</span>      <span style="color: #0000ff;">if</span>(ret == -<span style="color: #800080;">1</span><span style="color: #000000;">)
</span><span style="color: #008080;">329</span> <span style="color: #000000;">     {
</span><span style="color: #008080;">330</span>          perror(<span style="color: #800000;">"</span><span style="color: #800000;">setsockopt: SO_RCVTIMEO</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">331</span>         exit(-<span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;">332</span> <span style="color: #000000;">     }
</span><span style="color: #008080;">333</span> <span style="color: #000000;"> }
</span><span style="color: #008080;">334</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">335</span> <span style="color: #008000;"> *函数作用：设置套接字SO_SNDTIMEO选项，发送超时
</span><span style="color: #008080;">336</span> <span style="color: #008000;"> *函数参数：sockfd要设置的套接字, sec秒, usec毫秒
</span><span style="color: #008080;">337</span> <span style="color: #008000;"> *函数返回值: 无
</span><span style="color: #008080;">338</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">339</span>  <span style="color: #0000ff;">void</span> tyhp_set_snd_timeo(<span style="color: #0000ff;">int</span> sockfd, <span style="color: #0000ff;">int</span> sec, <span style="color: #0000ff;">int</span><span style="color: #000000;"> usec)
</span><span style="color: #008080;">340</span> <span style="color: #000000;"> {
</span><span style="color: #008080;">341</span>      <span style="color: #0000ff;">struct</span> timeval time=<span style="color: #000000;"> {sec, usec};
</span><span style="color: #008080;">342</span>      <span style="color: #0000ff;">int</span> ret = setsockopt(sockfd, SOL_SOCKET, SO_SNDTIMEO, &amp;time, <span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(time));
</span><span style="color: #008080;">343</span>      <span style="color: #0000ff;">if</span>(ret == -<span style="color: #800080;">1</span><span style="color: #000000;">)
</span><span style="color: #008080;">344</span> <span style="color: #000000;">     {
</span><span style="color: #008080;">345</span>          perror(<span style="color: #800000;">"</span><span style="color: #800000;">setsockopt: SO_SNDTIMEO</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">346</span>         exit(-<span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;">347</span> <span style="color: #000000;">     }
</span><span style="color: #008080;">348</span> <span style="color: #000000;"> }
</span><span style="color: #008080;">349</span> <span style="color: #008000;">/*</span><span style="color: #008000;">****************************************************************************************</span><span style="color: #008000;">*/</span>
<span style="color: #008080;">350</span> 
<span style="color: #008080;">351</span> <span style="color: #008000;">/*</span><span style="color: #008000;">**********************************  系统函数的包裹函数  ******************************************</span><span style="color: #008000;">*/</span>
<span style="color: #008080;">352</span> <span style="color: #0000ff;">int</span> tyhp_socket(<span style="color: #0000ff;">int</span> domain, <span style="color: #0000ff;">int</span> type, <span style="color: #0000ff;">int</span><span style="color: #000000;"> protocol)
</span><span style="color: #008080;">353</span> <span style="color: #000000;">{
</span><span style="color: #008080;">354</span>     <span style="color: #0000ff;">int</span><span style="color: #000000;"> listen_fd;
</span><span style="color: #008080;">355</span>     <span style="color: #0000ff;">if</span>((listen_fd = socket(AF_INET, SOCK_STREAM, <span style="color: #800080;">0</span>)) == -<span style="color: #800080;">1</span><span style="color: #000000;">)
</span><span style="color: #008080;">356</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">357</span>         perror(<span style="color: #800000;">"</span><span style="color: #800000;">socket</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">358</span>         exit(-<span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;">359</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">360</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> listen_fd;
</span><span style="color: #008080;">361</span> <span style="color: #000000;">}
</span><span style="color: #008080;">362</span> <span style="color: #0000ff;">void</span> tyhp_listen(<span style="color: #0000ff;">int</span> sockfd, <span style="color: #0000ff;">int</span><span style="color: #000000;"> backlog)
</span><span style="color: #008080;">363</span> <span style="color: #000000;">{
</span><span style="color: #008080;">364</span>     <span style="color: #0000ff;">if</span>(listen(sockfd, backlog) == -<span style="color: #800080;">1</span><span style="color: #000000;">)
</span><span style="color: #008080;">365</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">366</span>         perror(<span style="color: #800000;">"</span><span style="color: #800000;">listen</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">367</span>         exit(-<span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;">368</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">369</span> <span style="color: #000000;">}
</span><span style="color: #008080;">370</span> <span style="color: #0000ff;">void</span> tyhp_bind(<span style="color: #0000ff;">int</span> sockfd, <span style="color: #0000ff;">const</span> <span style="color: #0000ff;">struct</span> sockaddr *<span style="color: #000000;">addr, socklen_t addrlen)
</span><span style="color: #008080;">371</span> <span style="color: #000000;">{
</span><span style="color: #008080;">372</span>     <span style="color: #0000ff;">if</span>(bind(sockfd, addr, addrlen) == -<span style="color: #800080;">1</span><span style="color: #000000;">)
</span><span style="color: #008080;">373</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">374</span>         perror(<span style="color: #800000;">"</span><span style="color: #800000;">bind</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">375</span>         exit(-<span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;">376</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">377</span> <span style="color: #000000;">}
</span><span style="color: #008080;">378</span> <span style="color: #0000ff;">int</span> tyhp_accept(<span style="color: #0000ff;">int</span> sockfd, <span style="color: #0000ff;">struct</span> sockaddr *addr, socklen_t *<span style="color: #000000;">addrlen)
</span><span style="color: #008080;">379</span> <span style="color: #000000;">{
</span><span style="color: #008080;">380</span>     <span style="color: #0000ff;">int</span> ret_fd = <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">381</span>     <span style="color: #0000ff;">for</span><span style="color: #000000;">(;;)
</span><span style="color: #008080;">382</span> <span style="color: #000000;">    {    
</span><span style="color: #008080;">383</span>         ret_fd =<span style="color: #000000;"> accept(sockfd, addr, addrlen);
</span><span style="color: #008080;">384</span>         <span style="color: #0000ff;">if</span>(ret_fd &gt; <span style="color: #800080;">0</span><span style="color: #000000;">)
</span><span style="color: #008080;">385</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;">386</span>         <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span>(ret_fd == -<span style="color: #800080;">1</span><span style="color: #000000;">)
</span><span style="color: #008080;">387</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">388</span>             <span style="color: #008000;">//</span><span style="color: #008000;">由于我们把监听套接字设置为了非阻塞模式</span>
<span style="color: #008080;">389</span>             <span style="color: #0000ff;">if</span>(errno != EAGAIN &amp;&amp; errno != EPROTO &amp;&amp;
<span style="color: #008080;">390</span>                      errno != EINTR &amp;&amp; errno !=<span style="color: #000000;"> ECONNABORTED)
</span><span style="color: #008080;">391</span> <span style="color: #000000;">            {    
</span><span style="color: #008080;">392</span>                 perror(<span style="color: #800000;">"</span><span style="color: #800000;">accept</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">393</span>                 exit(-<span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;">394</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">395</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">396</span>         <span style="color: #0000ff;">else</span>
<span style="color: #008080;">397</span>             <span style="color: #0000ff;">continue</span><span style="color: #000000;">;
</span><span style="color: #008080;">398</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">399</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> ret_fd;
</span><span style="color: #008080;">400</span> <span style="color: #000000;">}
</span><span style="color: #008080;">401</span> <span style="color: #0000ff;">struct</span> servent* tyhp_getservbyname(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *name, <span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *<span style="color: #000000;">proto)
</span><span style="color: #008080;">402</span> <span style="color: #000000;">{
</span><span style="color: #008080;">403</span>     <span style="color: #0000ff;">struct</span> servent     *<span style="color: #000000;">pservent;
</span><span style="color: #008080;">404</span>     <span style="color: #0000ff;">if</span>((pservent = getservbyname(name, proto)) ==<span style="color: #000000;"> NULL)
</span><span style="color: #008080;">405</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">406</span>         perror(<span style="color: #800000;">"</span><span style="color: #800000;">getservbyname</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">407</span>         exit(-<span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;">408</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">409</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> pservent;
</span><span style="color: #008080;">410</span> <span style="color: #000000;">}
</span><span style="color: #008080;">411</span> <span style="color: #0000ff;">int</span> tyhp_epoll_create(<span style="color: #0000ff;">int</span><span style="color: #000000;"> size)
</span><span style="color: #008080;">412</span> <span style="color: #000000;">{
</span><span style="color: #008080;">413</span>     <span style="color: #0000ff;">int</span><span style="color: #000000;"> epollfd;
</span><span style="color: #008080;">414</span>     epollfd =<span style="color: #000000;"> epoll_create(size);
</span><span style="color: #008080;">415</span>     <span style="color: #0000ff;">if</span>(-<span style="color: #800080;">1</span> ==<span style="color: #000000;"> epollfd)
</span><span style="color: #008080;">416</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">417</span>         perror(<span style="color: #800000;">"</span><span style="color: #800000;">epoll_create</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">418</span>         exit(-<span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;">419</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">420</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> epollfd;
</span><span style="color: #008080;">421</span> <span style="color: #000000;">}
</span><span style="color: #008080;">422</span> <span style="color: #0000ff;">void</span> tyhp_epoll_ctl(<span style="color: #0000ff;">int</span> epfd, <span style="color: #0000ff;">int</span> op, <span style="color: #0000ff;">int</span> fd, <span style="color: #0000ff;">struct</span> epoll_event *<span style="color: #0000ff;">event</span><span style="color: #000000;">)
</span><span style="color: #008080;">423</span> <span style="color: #000000;">{
</span><span style="color: #008080;">424</span>     <span style="color: #0000ff;">if</span>(epoll_ctl(epfd, op, fd, <span style="color: #0000ff;">event</span>) == -<span style="color: #800080;">1</span><span style="color: #000000;">)
</span><span style="color: #008080;">425</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">426</span>         perror(<span style="color: #800000;">"</span><span style="color: #800000;">epoll_ctl</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">427</span>         exit(-<span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;">428</span> <span style="color: #000000;">    }    
</span><span style="color: #008080;">429</span> <span style="color: #000000;">}
</span><span style="color: #008080;">430</span> <span style="color: #0000ff;">int</span> tyhp_epoll_wait(<span style="color: #0000ff;">int</span> epfd, <span style="color: #0000ff;">struct</span> epoll_event *events, <span style="color: #0000ff;">int</span> maxevents, <span style="color: #0000ff;">int</span><span style="color: #000000;"> timeout)
</span><span style="color: #008080;">431</span> <span style="color: #000000;">{
</span><span style="color: #008080;">432</span> <span style="color: #000000;">again:
</span><span style="color: #008080;">433</span>     <span style="color: #0000ff;">int</span> nfds =<span style="color: #000000;"> epoll_wait(epfd, events, maxevents, timeout);
</span><span style="color: #008080;">434</span>     <span style="color: #0000ff;">if</span>(nfds == -<span style="color: #800080;">1</span>) <span style="color: #008000;">//</span><span style="color: #008000;">&amp;&amp; errno != EINTR)</span>
<span style="color: #008080;">435</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">436</span>         <span style="color: #0000ff;">if</span>(errno !=<span style="color: #000000;"> EINTR)
</span><span style="color: #008080;">437</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">438</span>             perror(<span style="color: #800000;">"</span><span style="color: #800000;">epoll_wait</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">439</span>             exit(-<span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;">440</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">441</span>         <span style="color: #0000ff;">else</span>
<span style="color: #008080;">442</span>             <span style="color: #0000ff;">goto</span><span style="color: #000000;"> again;
</span><span style="color: #008080;">443</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">444</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> nfds;
</span><span style="color: #008080;">445</span> <span style="color: #000000;">}
</span><span style="color: #008080;">446</span> 
<span style="color: #008080;">447</span> <span style="color: #0000ff;">void</span> *<span style="color: #000000;">tyhp_calloc(size_t nmemb, size_t size)
</span><span style="color: #008080;">448</span> <span style="color: #000000;">{
</span><span style="color: #008080;">449</span>     <span style="color: #0000ff;">void</span> *ptr =<span style="color: #000000;"> calloc(nmemb, size);
</span><span style="color: #008080;">450</span>     <span style="color: #0000ff;">if</span>(NULL ==<span style="color: #000000;"> ptr)
</span><span style="color: #008080;">451</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">452</span>         perror(<span style="color: #800000;">"</span><span style="color: #800000;">tyhp_calloc</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">453</span>         exit(-<span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;">454</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">455</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> ptr;
</span><span style="color: #008080;">456</span> <span style="color: #000000;">}
</span><span style="color: #008080;">457</span> <span style="color: #0000ff;">void</span> *<span style="color: #000000;">tyhp_malloc(size_t size)
</span><span style="color: #008080;">458</span> <span style="color: #000000;">{
</span><span style="color: #008080;">459</span>     <span style="color: #0000ff;">void</span> *ptr =<span style="color: #000000;"> malloc(size);
</span><span style="color: #008080;">460</span>     <span style="color: #0000ff;">if</span>(NULL ==<span style="color: #000000;"> ptr)
</span><span style="color: #008080;">461</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">462</span>         perror(<span style="color: #800000;">"</span><span style="color: #800000;">tyhp_malloc</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">463</span>         exit(-<span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;">464</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">465</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> ptr;
</span><span style="color: #008080;">466</span> <span style="color: #000000;">}
</span><span style="color: #008080;">467</span> <span style="color: #0000ff;">void</span> tyhp_free(<span style="color: #0000ff;">void</span> *<span style="color: #000000;">ptr)
</span><span style="color: #008080;">468</span> <span style="color: #000000;">{
</span><span style="color: #008080;">469</span> <span style="color: #000000;">    free(ptr);
</span><span style="color: #008080;">470</span> <span style="color: #000000;">}
</span><span style="color: #008080;">471</span> <span style="color: #008000;">/*</span><span style="color: #008000;">****************************************************************************************</span><span style="color: #008000;">*/</span></pre>
</div>
<p>&nbsp;</p></div><div id="MySignature"></div>
<div class="clear"></div>
<div id="blog_post_info_block">
<div id="BlogPostCategory"></div>
<div id="EntryTag"></div>
<div id="blog_post_info">
</div>
<div class="clear"></div>
<div id="post_next_prev"></div>
</div>


		</div>
		<div class = "postDesc">posted @ <span id="post-date">2013-10-16 10:52</span> <a href='http://www.cnblogs.com/zxh1210603696/'>老司机</a> 阅读(<span id="post_view_count">...</span>) 评论(<span id="post_comment_count">...</span>)  <a href ="http://i.cnblogs.com/EditPosts.aspx?postid=3371715" rel="nofollow">编辑</a> <a href="#" onclick="AddToWz(3371715);return false;">收藏</a></div>
	</div>
	<script type="text/javascript">var allowComments=true,isLogined=true,cb_blogId=157390,cb_entryId=3371715,cb_blogApp=currentBlogApp,cb_blogUserGuid='89fcd94d-5ded-e211-8d02-90b11c0b17d6',cb_entryCreatedDate='2013/10/16 10:52:00';loadViewCount(cb_entryId);</script>
	
</div><!--end: topics 文章、评论容器-->
</div><a name="!comments"></a><div id="blog-comments-placeholder"></div><script type="text/javascript">var commentManager = new blogCommentManager();commentManager.renderComments(0);</script>
<div id="comment_form" class="commentform">
<a name="commentform"></a>
<div id="divCommentShow"></div>
<div id="comment_nav"><span id="span_refresh_tips"></span><a href="javascript:void(0);" id="lnk_RefreshComments" onclick="return RefreshCommentList();">刷新评论</a><a href="#" onclick="return RefreshPage();">刷新页面</a><a href="#top">返回顶部</a></div>
<div id="comment_form_container"></div>
<div class="ad_text_commentbox" id="ad_text_under_commentbox"></div>
<div id="site_nav_under"><a href="http://www.cnblogs.com/" target="_blank" title="开发者的网上家园">博客园首页</a><a href="http://q.cnblogs.com/" target="_blank" title="程序员问答社区">博问</a><a href="http://news.cnblogs.com/" target="_blank" title="IT新闻">新闻</a><a href="http://home.cnblogs.com/ing/" target="_blank">闪存</a><a href="http://job.cnblogs.com/" target="_blank">程序员招聘</a><a href="http://kb.cnblogs.com/" target="_blank">知识库</a></div>
<div id="opt_under_post"></div>
<script type="text/javascript">
    fixPostBodyFormat();
</script>
<div id="google_ad_c1" class="c_ad_block"></div>
<div id="under_post_news"></div>
<div id="google_ad_c2" class="c_ad_block"></div>
<div id="under_post_kb"></div>
<div id="google_ad_c3" class="c_ad_block">
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- C3_BlogPost -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:250px"
     data-ad-client="ca-pub-4210569241504288"
     data-ad-slot="3239908880"></ins>
<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<div id="HistoryToday" class="c_ad_block"></div>
<script type="text/javascript">
$(function () {
    loadNewsAndKb();
    loadBlogSignature();
    LoadPostInfoBlock(cb_blogId, cb_entryId, cb_blogApp, cb_blogUserGuid);
    GetPrevNextPost(cb_entryId, cb_blogId, cb_entryCreatedDate);
    loadOptUnderPost();
    GetHistoryToday(cb_blogId, cb_blogApp, cb_entryCreatedDate);
    setTimeout(function () { incrementViewCount(cb_entryId); }, 200);
});
</script>
</div>

	</div><!--end: forFlow -->
	</div><!--end: mainContent 主体内容容器-->

	<div id="sideBar">
		<div id="sideBarMain">
			
<!--done-->
<div class="newsItem">
<h3 class="catListTitle">公告</h3>
	<div id="blog-news"></div><script type="text/javascript">loadBlogNews();</script>
</div>

			<div id="calendar"><div id="blog-calendar" style="display:none"></div><script type="text/javascript">loadBlogDefaultCalendar();</script></div>
			
			<DIV id="leftcontentcontainer">
				<div id="blog-sidecolumn"></div><script type="text/javascript">loadBlogSideColumn();</script>
			</DIV>
			
		</div><!--end: sideBarMain -->
	</div><!--end: sideBar 侧边栏容器 -->
	<div class="clear"></div>
	</div><!--end: main -->
	<div class="clear"></div>
	<div id="footer">
		
<!--done-->
Copyright &copy;2015 老司机
	</div><!--end: footer -->
</div><!--end: home 自定义的最大容器 -->
</body>
</html>
